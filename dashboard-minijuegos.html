<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Dashboard mini-juegos ¬∑ Gorri√≥n Wine Experience</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root{
      --bg:#050711;
      --bg2:#0a0d18;
      --card:#111522;
      --soft:#191e30;
      --accent:#ffb347;
      --accent2:#ff6f61;
      --accentBubbles:#6ee7ff;
      --accentLinea:#9be7a1;
      --text:#f5f5f7;
      --muted:#b7bbc7;
      --radius:18px;
      --shadow:0 14px 40px rgba(0,0,0,.55);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      min-height:100vh;
      font-family: system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
      color:var(--text);
      background:
        radial-gradient(900px 500px at 10% -10%, color-mix(in oklab, var(--accentBubbles) 24%, transparent), transparent 60%),
        radial-gradient(800px 500px at 110% 0%, color-mix(in oklab, var(--accent2) 20%, transparent), transparent 60%),
        linear-gradient(180deg, var(--bg), var(--bg2));
      padding:16px;
      -webkit-font-smoothing:antialiased;
    }
    .shell{
      max-width:1000px;
      margin:0 auto;
    }
    header{
      margin-bottom:14px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    h1{
      font-size:1.35rem;
      letter-spacing:.08em;
      text-transform:uppercase;
    }
    .subtitle{
      font-size:.85rem;
      color:var(--muted);
      margin-top:4px;
      max-width:520px;
    }
    .badge-row{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:8px;
      font-size:.78rem;
    }
    .badge{
      padding:4px 8px;
      border-radius:999px;
      border:1px solid #343a59;
      background:rgba(5,10,25,.85);
      color:var(--muted);
      display:inline-flex;
      align-items:center;
      gap:4px;
    }
    .badge strong{color:var(--text);}

    .pill-game{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid #313856;
      background:#0b0f20;
      font-size:.8rem;
    }
    .pill-game span{
      opacity:.85;
    }
    .pill-game.active[data-game="bubbles"]{
      border-color:var(--accentBubbles);
      box-shadow:0 0 12px rgba(110,231,255,.35);
    }
    .pill-game.active[data-game="linea"]{
      border-color:var(--accentLinea);
      box-shadow:0 0 12px rgba(155,231,161,.35);
    }
    .pill-game.active[data-game="cata"],
    .pill-game.active[data-game="summary"]{
      border-color:var(--accent);
      box-shadow:0 0 12px rgba(255,179,71,.35);
    }

    .layout{
      display:grid;
      grid-template-columns: minmax(0,3fr) minmax(0,2fr);
      gap:14px;
    }
    @media (max-width:820px){
      .layout{
        grid-template-columns: minmax(0,1fr);
      }
    }

    .card{
      background:rgba(10,12,24,.96);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      border:1px solid #252a3f;
      padding:12px 14px 14px;
    }

    .card h2{
      font-size:1rem;
      margin-bottom:6px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .card h2 span.icon{
      font-size:1.1rem;
    }
    .card-sub{
      font-size:.8rem;
      color:var(--muted);
      margin-bottom:10px;
    }

    table{
      width:100%;
      border-collapse:collapse;
      font-size:.82rem;
    }
    thead{
      background:#0c1020;
    }
    th,td{
      padding:6px 6px;
      text-align:left;
      border-bottom:1px solid rgba(52,59,92,.55);
      white-space:nowrap;
    }
    th{
      font-weight:600;
      color:var(--muted);
      font-size:.78rem;
    }
    tbody tr:nth-child(odd){
      background:rgba(10,14,28,.75);
    }
    tbody tr:nth-child(even){
      background:rgba(7,10,22,.75);
    }
    tbody tr.leader{
      background:linear-gradient(90deg, rgba(255,179,71,.18), rgba(255,111,97,.14));
    }
    tbody tr.leader td{
      border-bottom-color:rgba(255,179,71,.4);
    }
    .td-name{
      font-weight:600;
    }
    .td-rank{
      font-weight:700;
      width:40px;
    }
    .td-rank span.trophy{
      font-size:1rem;
    }
    .td-secondary{
      color:var(--muted);
      font-size:.78rem;
    }
    .empty{
      font-size:.82rem;
      color:var(--muted);
      padding:8px 0 10px;
    }

    .summary-grid{
      display:grid;
      grid-template-columns: repeat(2,minmax(0,1fr));
      gap:8px;
      margin-top:6px;
    }
    @media (max-width:480px){
      .summary-grid{
        grid-template-columns:minmax(0,1fr);
      }
    }
    .stat{
      background:#090d1b;
      border-radius:12px;
      padding:8px 10px;
      border:1px solid #2c3245;
      font-size:.8rem;
    }
    .stat-label{
      color:var(--muted);
      font-size:.75rem;
      margin-bottom:2px;
    }
    .stat-value{
      font-weight:700;
      font-size:.95rem;
    }
    .stat small{
      font-size:.75rem;
      color:var(--muted);
    }

    .hint{
      margin-top:10px;
      font-size:.78rem;
      color:var(--muted);
    }

    .chip{
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid #333a55;
      font-size:.75rem;
      background:#050816;
      color:var(--muted);
    }
    .chip strong{color:var(--text);}

    .game-label{
      font-weight:700;
    }

    /* Podio resumen */
    #summaryPodium{
      display:none;
      margin-top:10px;
    }
    .podio-grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:16px;
    }
    .podio-block-title{
      font-size:.85rem;
      color:var(--muted);
      margin-bottom:6px;
    }
    .podio-line{
      display:flex;
      align-items:center;
      gap:8px;
      margin-bottom:4px;
    }
    .podio-rank{
      font-size:1.1rem;
      font-weight:800;
    }
    .podio-name{
      font-size:1rem;
      font-weight:700;
    }

    /* ===== Bot√≥n Fullscreen ===== */
    .fs-btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      padding:8px 10px;
      border-radius:12px;
      border:1px solid #313856;
      background:#0b0f20;
      color:var(--text);
      font-size:.78rem;
      cursor:pointer;
      transition:.15s ease;
      box-shadow:0 6px 16px rgba(0,0,0,.25);
    }
    .fs-btn:hover{
      border-color:var(--accent);
      box-shadow:0 0 12px rgba(255,179,71,.25);
      transform:translateY(-1px);
    }
    .fs-btn:active{
      transform:translateY(0);
    }
    .fs-btn .fs-ico{
      font-size:1rem;
      line-height:1;
    }

    /* ===================== MODO TV ===================== */
    body.tv-mode{
      padding:10px;
    }
    body.tv-mode .shell{
      max-width:1280px;
    }
    body.tv-mode header{
      justify-content:center;
      text-align:center;
      margin-bottom:10px;
    }
    body.tv-mode h1{
      font-size:2.1rem;
      letter-spacing:.12em;
    }
    body.tv-mode .subtitle{
      font-size:1rem;
      max-width:none;
    }
    body.tv-mode .badge-row{
      display:none;
    }
    body.tv-mode .pill-game{
      font-size:.95rem;
      padding:6px 14px;
    }
    body.tv-mode #gameHint{
      font-size:.9rem;
      max-width:none;
    }

    body.tv-mode .layout{
      grid-template-columns:minmax(0,1fr);
    }
    body.tv-mode aside.card{
      display:none;
    }
    body.tv-mode #rankingCard{
      padding:14px 18px 18px;
    }
    body.tv-mode #rankingTitle{
      font-size:1.6rem;
    }
    body.tv-mode #rankingIcon{
      font-size:1.8rem;
    }
    body.tv-mode .card-sub{
      font-size:.95rem;
      margin-bottom:12px;
    }

    body.tv-mode table{
      font-size:1rem;
    }
    body.tv-mode th{
      font-size:.9rem;
      padding:8px 10px;
    }
    body.tv-mode td{
      padding:8px 10px;
    }
    body.tv-mode .td-name{
      font-size:1.2rem;
    }
    body.tv-mode .td-rank{
      font-size:1.2rem;
      width:60px;
    }
    body.tv-mode .td-secondary{
      font-size:.9rem;
    }
    body.tv-mode tbody tr.leader{
      box-shadow:0 0 25px rgba(255,179,71,.25);
    }

    body.tv-mode .empty{
      font-size:1rem;
      text-align:center;
    }

    body.tv-mode #summaryPodium .podio-rank{
      font-size:1.6rem;
    }
    body.tv-mode #summaryPodium .podio-name{
      font-size:1.3rem;
    }

    body.tv-mode .fs-btn{
      font-size:.95rem;
      padding:10px 14px;
      border-radius:14px;
    }
  </style>
</head>
<body>
  <div class="shell">
    <header>
      <div>
        <h1>Dashboard mini-juegos</h1>
        <div class="subtitle" id="subtitleMain">
          Ranking en directo de los invitados seg√∫n el mini-juego activo: Bubble Pop de Aromas ü´ß o Test alcoholemia üìà.
        </div>
        <div class="badge-row">
          <div class="badge">
            <span>üîÑ</span><span>Se actualiza en tiempo real desde Firebase RTDB.</span>
          </div>
          <div class="badge">
            <span>üßë‚Äçüíª</span><span>Un invitado = un nombre de <strong>gw_name</strong>.</span>
          </div>
        </div>
      </div>

      <div>
        <div style="display:flex; justify-content:flex-end; gap:8px; margin-bottom:8px;">
          <button class="fs-btn" id="btnFullscreen" type="button" aria-label="Pantalla completa">
            <span class="fs-ico" id="fsIcon">‚õ∂</span>
            <span id="fsLabel">Fullscreen</span>
          </button>
        </div>

        <div class="pill-game active" data-game="cata" id="pillCata">
          <span>üé¨</span>
          <span>Pantalla: <strong class="game-label" id="currentGameLabel">Cata</strong></span>
        </div>
        <div style="margin-top:6px; display:flex; flex-direction:column; gap:4px; font-size:.78rem; color:var(--muted); max-width:260px;">
          <span id="gameHint">Cuando el host lance un mini-juego, aqu√≠ aparecer√° el ranking.</span>
        </div>
      </div>
    </header>

    <div class="layout">
      <section class="card" id="rankingCard">
        <h2>
          <span class="icon" id="rankingIcon">üèÜ</span>
          <span id="rankingTitle">Ranking en espera</span>
        </h2>
        <div class="card-sub" id="rankingSub">
          Esperando a que haya un mini-juego activo y resultados de los invitados.
        </div>

        <div id="tableWrap">
          <table>
            <thead>
              <tr id="tableHeadRow">
                <th>#</th>
                <th>Invitado</th>
                <th id="mainMetricHead">M√©trica</th>
                <th id="secondaryMetricHead">Extra</th>
              </tr>
            </thead>
            <tbody id="rankingBody"></tbody>
          </table>
        </div>
        <div class="empty" id="emptyMsg" style="display:none;">
          Nadie ha terminado todav√≠a este mini-juego. Cuando lleguen resultados, aparecer√°n aqu√≠.
        </div>

        <!-- Vista de podio resumen (summary) -->
        <div id="summaryPodium">
          <!-- Se rellena por JS -->
        </div>
      </section>

      <aside class="card">
        <h2>
          <span class="icon">üìä</span>
          Resumen r√°pido
        </h2>
        <div class="card-sub">
          Vista r√°pida del ganador y algunos agregados del mini-juego activo.
        </div>

        <div class="summary-grid">
          <div class="stat">
            <div class="stat-label">Participantes</div>
            <div class="stat-value" id="statPlayers">‚Äì</div>
            <small id="statPlayersHelp">Con al menos un resultado guardado.</small>
          </div>
          <div class="stat">
            <div class="stat-label">Ganador actual</div>
            <div class="stat-value" id="statWinner">‚Äì</div>
            <small id="statWinnerHelp">Top 1 seg√∫n la m√©trica del juego.</small>
          </div>
          <div class="stat">
            <div class="stat-label" id="statMetricLabel">M√©trica media</div>
            <div class="stat-value" id="statMetricValue">‚Äì</div>
            <small id="statMetricHelp">Depende del mini-juego activo.</small>
          </div>
          <div class="stat">
            <div class="stat-label">√öltima actualizaci√≥n</div>
            <div class="stat-value" id="statUpdated">‚Äì</div>
            <small id="statUpdatedHelp">Hora aproximada (local del navegador).</small>
          </div>
        </div>

        <div class="hint" id="sideHint">
          <span class="chip"><span>üí°</span><span>Consejo: usa este dashboard en una pantalla grande mientras los invitados juegan desde el m√≥vil.</span></span>
        </div>
      </aside>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
    import { getDatabase, ref, onValue, off } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDwlXwWlmgLhwgjONXQmWE7O5H54aZd6dk",
      authDomain: "catas-9d780.firebaseapp.com",
      databaseURL: "https://catas-9d780-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "catas-9d780",
      storageBucket: "catas-9d780.firebasestorage.app",
      messagingSenderId: "554356727364",
      appId: "1:554356727364:web:2e8a754067872751efa611",
      measurementId: "G-F2YRVJ9B00"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    const qs = new URLSearchParams(location.search);
    const tvMode = qs.get("tv") === "1";

    if(tvMode){
      document.body.classList.add("tv-mode");
      const sub = document.getElementById("subtitleMain");
      if(sub){
        sub.textContent = "Modo TV ¬∑ Ranking en directo para la pantalla de la sala.";
      }
    }

    const subtitleMain = document.getElementById("subtitleMain");

    const pillCata = document.getElementById("pillCata");
    const currentGameLabel = document.getElementById("currentGameLabel");
    const gameHint = document.getElementById("gameHint");

    const rankingIcon = document.getElementById("rankingIcon");
    const rankingTitle = document.getElementById("rankingTitle");
    const rankingSub = document.getElementById("rankingSub");
    const rankingBody = document.getElementById("rankingBody");
    const emptyMsg = document.getElementById("emptyMsg");
    const tableWrap = document.getElementById("tableWrap");
    const mainMetricHead = document.getElementById("mainMetricHead");
    const secondaryMetricHead = document.getElementById("secondaryMetricHead");
    const summaryPodium = document.getElementById("summaryPodium");

    const statPlayers = document.getElementById("statPlayers");
    const statPlayersHelp = document.getElementById("statPlayersHelp");
    const statWinner = document.getElementById("statWinner");
    const statWinnerHelp = document.getElementById("statWinnerHelp");
    const statMetricLabel = document.getElementById("statMetricLabel");
    const statMetricValue = document.getElementById("statMetricValue");
    const statMetricHelp = document.getElementById("statMetricHelp");
    const statUpdated = document.getElementById("statUpdated");
    const statUpdatedHelp = document.getElementById("statUpdatedHelp");

    // ================= Fullscreen =================
    const btnFullscreen = document.getElementById("btnFullscreen");
    const fsIcon = document.getElementById("fsIcon");
    const fsLabel = document.getElementById("fsLabel");

    function isFullscreen(){
      return !!document.fullscreenElement;
    }

    function updateFsUI(){
      if(!btnFullscreen) return;
      if(isFullscreen()){
        if(fsIcon) fsIcon.textContent = "üß©";
        if(fsLabel) fsLabel.textContent = "Salir";
        btnFullscreen.setAttribute("aria-label", "Salir de pantalla completa");
      }else{
        if(fsIcon) fsIcon.textContent = "‚õ∂";
        if(fsLabel) fsLabel.textContent = "Fullscreen";
        btnFullscreen.setAttribute("aria-label", "Entrar en pantalla completa");
      }
    }

    async function toggleFullscreen(){
      try{
        if(!isFullscreen()){
          await document.documentElement.requestFullscreen();
        }else{
          await document.exitFullscreen();
        }
      }catch(_e){
        // Algunos navegadores pueden bloquear la llamada si no es un gesto de usuario v√°lido
      }finally{
        updateFsUI();
      }
    }

    if(btnFullscreen){
      btnFullscreen.addEventListener("click", toggleFullscreen);
      document.addEventListener("fullscreenchange", updateFsUI);
      updateFsUI();
    }

    // =================================================

    let currentResultsUnsub = null;
    let currentMode = "cata";

    let bubblesResultsCache = {};
    let lineaResultsCache = {};
    let summaryListenersAttached = false;

    function localTimeString(ts){
      if(!ts) return "‚Äì";
      try{
        const d = new Date(ts);
        return d.toLocaleTimeString([], { hour:"2-digit", minute:"2-digit", second:"2-digit" });
      }catch(_e){
        return "‚Äì";
      }
    }

    function setGamePill(game){
      currentMode = game || "cata";
      pillCata.dataset.game = currentMode;
      pillCata.classList.add("active");

      if(game === "bubbles"){
        currentGameLabel.textContent = "Bubble Pop de Aromas";
      }else if(game === "linea"){
        currentGameLabel.textContent = "Test alcoholemia";
      }else if(game === "summary"){
        currentGameLabel.textContent = "Podio final";
      }else{
        currentGameLabel.textContent = "Cata";
      }
    }

    function clearRanking(){
      rankingBody.innerHTML = "";
      emptyMsg.style.display = "none";
    }

    function renderNoGame(){
      setGamePill("cata");
      rankingIcon.textContent = "‚è≥";
      rankingTitle.textContent = "Esperando mini-juego activo";
      rankingSub.textContent = "Cuando el host lance Bubble Pop o el Test alcoholemia, el ranking aparecer√° aqu√≠.";

      tableWrap.style.display = "";
      summaryPodium.style.display = "none";

      clearRanking();
      emptyMsg.style.display = "block";
      emptyMsg.textContent = "Sin mini-juego activo ahora mismo.";
      statPlayers.textContent = "‚Äì";
      statWinner.textContent = "‚Äì";
      statMetricValue.textContent = "‚Äì";
      statUpdated.textContent = "‚Äì";
      gameHint.textContent = tvMode
        ? "Modo TV: ponlo en pantalla grande y deja que el host lance los mini-juegos."
        : "El host controla el mini-juego desde la pantalla de cata.";
      statPlayersHelp.textContent = "Participantes con resultados guardados.";
      statMetricLabel.textContent = "M√©trica media";
      statMetricHelp.textContent = "Se calcular√° seg√∫n el mini-juego.";
      statWinnerHelp.textContent = "Top 1 seg√∫n la m√©trica del juego.";
      statUpdatedHelp.textContent = "Hora aproximada (local del navegador).";
    }

    function attachResultsListener(game){
      if(currentResultsUnsub){
        currentResultsUnsub();
        currentResultsUnsub = null;
      }

      if(game === "bubbles"){
        const rRef = ref(db, "miniGames/bubbles/results");
        onValue(rRef, snap => {
          const data = snap.val() || {};
          renderBubblesRanking(data);
        });
        currentResultsUnsub = () => off(rRef);
      }else if(game === "linea"){
        const rRef = ref(db, "miniGames/linea/results");
        onValue(rRef, snap => {
          const data = snap.val() || {};
          renderLineaRanking(data);
        });
        currentResultsUnsub = () => off(rRef);
      }
    }

    // Helpers para resumen (Top 3 de ambos juegos)
    function buildTop3FromBubbles(results){
      const arr = Object.values(results || {}).filter(r => r && typeof r === "object");
      arr.sort((a,b)=>{
        const aScore = a.totalScore || 0;
        const bScore = b.totalScore || 0;
        if(bScore !== aScore) return bScore - aScore;
        const aAcc = a.avgAccuracy || 0;
        const bAcc = b.avgAccuracy || 0;
        if(bAcc !== aAcc) return bAcc - aAcc;
        const aTs = a.ts || 0;
        const bTs = b.ts || 0;
        return aTs - bTs;
      });
      return arr.slice(0, 3);
    }

    function buildTop3FromLinea(results){
      const arr = Object.values(results || {}).filter(r => r && typeof r === "object");
      arr.sort((a,b)=>{
        const aPct = a.avgPercent || 0;
        const bPct = b.avgPercent || 0;
        if(bPct !== aPct) return bPct - aPct;
        const aSec = a.avgInsideSec || 0;
        const bSec = b.avgInsideSec || 0;
        if(bSec !== aSec) return bSec - aSec;
        const aTs = a.ts || 0;
        const bTs = b.ts || 0;
        return aTs - bTs;
      });
      return arr.slice(0, 3);
    }

    function renderSummaryPodium(){
      if(currentMode !== "summary") return;
      tableWrap.style.display = "none";
      emptyMsg.style.display = "none";
      summaryPodium.style.display = "block";

      const topB = buildTop3FromBubbles(bubblesResultsCache);
      const topL = buildTop3FromLinea(lineaResultsCache);

      if(!topB.length && !topL.length){
        summaryPodium.innerHTML = '<div class="empty">Todav√≠a no hay resultados suficientes en los mini-juegos.</div>';
        statPlayers.textContent = "0";
        statWinner.textContent = "‚Äì";
        statMetricLabel.textContent = "Resumen";
        statMetricValue.textContent = "‚Äì";
        statUpdated.textContent = "‚Äì";
        gameHint.textContent = "Vista de podio final ¬∑ Esperando resultados.";
        return;
      }

      const renderList = (items) => {
        if(!items.length) return '<div class="empty">Sin datos a√∫n</div>';
        return items.map((p, idx) => {
          const pos = idx+1;
          const medal = pos === 1 ? "ü•á" : (pos === 2 ? "ü•à" : "ü•â");
          const name = (p.name || p.sessionId || "Invitado").toString().toUpperCase();
          return `
            <div class="podio-line">
              <div class="podio-rank">${medal} ${pos}¬∫</div>
              <div class="podio-name">${name}</div>
            </div>
          `;
        }).join("");
      };

      summaryPodium.innerHTML = `
        <div class="podio-grid">
          <div>
            <div class="podio-block-title">ü´ß Bubble Pop de Aromas</div>
            ${renderList(topB)}
          </div>
          <div>
            <div class="podio-block-title">üìà Test alcoholemia</div>
            ${renderList(topL)}
          </div>
        </div>
      `;

      // Estad√≠sticas laterales sencillas
      statPlayers.textContent = String(
        new Set([
          ...Object.keys(bubblesResultsCache || {}),
          ...Object.keys(lineaResultsCache || {})
        ]).size
      );
      statWinner.textContent = [
        topB[0]?.name || topB[0]?.sessionId,
        topL[0]?.name || topL[0]?.sessionId
      ].filter(Boolean).map(n => n.toString().toUpperCase()).join(" ¬∑ ") || "‚Äî";

      statMetricLabel.textContent = "Ganadores";
      statMetricValue.textContent = "Top 3 de cada juego";
      statMetricHelp.textContent = "Se calcula con los rankings de Bubble Pop y Test alcoholemia.";

      // √öltima actualizaci√≥n combinada
      let lastTs = 0;
      Object.values(bubblesResultsCache || {}).forEach(r => { lastTs = Math.max(lastTs, r?.ts || 0); });
      Object.values(lineaResultsCache || {}).forEach(r => { lastTs = Math.max(lastTs, r?.ts || 0); });
      statUpdated.textContent = localTimeString(lastTs);
      gameHint.textContent = "Vista de podio final ¬∑ Top 3 de ambos mini-juegos.";
    }

    function attachSummaryListenersOnce(){
      if(summaryListenersAttached) return;
      summaryListenersAttached = true;

      const bubblesResultsRef = ref(db, "miniGames/bubbles/results");
      const lineaResultsRef   = ref(db, "miniGames/linea/results");

      onValue(bubblesResultsRef, (snap)=>{
        bubblesResultsCache = snap.val() || {};
        renderSummaryPodium();
      });

      onValue(lineaResultsRef, (snap)=>{
        lineaResultsCache = snap.val() || {};
        renderSummaryPodium();
      });
    }

    function renderBubblesRanking(results){
      setGamePill("bubbles");
      rankingIcon.textContent = "ü´ß";
      rankingTitle.textContent = "Ranking ¬∑ Bubble Pop de Aromas";
      rankingSub.textContent = "Ordenado por aciertos totales (y precisi√≥n media como desempate).";

      tableWrap.style.display = "";
      summaryPodium.style.display = "none";

      mainMetricHead.textContent = "Aciertos totales";
      secondaryMetricHead.textContent = "Precisi√≥n media / Fallos";

      let entries = Object.entries(results || {}).map(([id, r]) => ({
        id,
        name: (r && r.name) || id,
        winesPlayed: r?.winesPlayed ?? 0,
        totalScore: r?.totalScore ?? 0,
        totalMistakes: r?.totalMistakes ?? 0,
        totalMissed: r?.totalMissed ?? 0,
        avgAccuracy: r?.avgAccuracy ?? 0,
        ts: r?.ts ?? 0
      }));

      entries.sort((a,b)=>{
        if(b.totalScore !== a.totalScore) return b.totalScore - a.totalScore;
        if(b.avgAccuracy !== a.avgAccuracy) return b.avgAccuracy - a.avgAccuracy;
        return (b.ts||0) - (a.ts||0);
      });
      entries = entries.slice(0, 12);

      clearRanking();

      if(!entries.length){
        emptyMsg.style.display = "block";
        emptyMsg.textContent = "Todav√≠a no hay resultados guardados de Bubble Pop.";
        statPlayers.textContent = "0";
        statWinner.textContent = "‚Äì";
        statMetricLabel.textContent = "Precisi√≥n media (%)";
        statMetricValue.textContent = "‚Äì";
        statMetricHelp.textContent = "Se actualizar√° cuando haya resultados.";
        statUpdated.textContent = "‚Äì";
        gameHint.textContent = "Mini-juego activo: Bubble Pop de Aromas.";
        return;
      }

      let lastTs = 0;
      let sumAcc = 0;
      entries.forEach((p, idx)=>{
        const tr = document.createElement("tr");
        if(idx === 0) tr.classList.add("leader");
        tr.innerHTML = `
          <td class="td-rank">${idx === 0 ? '<span class="trophy">üèÜ</span>' : idx+1}</td>
          <td class="td-name">${p.name}</td>
          <td><strong>${p.totalScore}</strong> aciertos</td>
          <td class="td-secondary">
            üéØ ${p.avgAccuracy}% ¬∑ ‚ùå ${p.totalMistakes} ¬∑ üí® ${p.totalMissed}
          </td>
        `;
        rankingBody.appendChild(tr);
        lastTs = Math.max(lastTs, p.ts || 0);
        sumAcc += p.avgAccuracy || 0;
      });

      const avgAcc = Math.round(sumAcc / entries.length);

      statPlayers.textContent = String(entries.length);
      statWinner.textContent = entries[0].name;
      statMetricLabel.textContent = "Precisi√≥n media (%)";
      statMetricValue.textContent = `${avgAcc}%`;
      statMetricHelp.textContent = "Promedio de precisi√≥n entre todos los jugadores (top 12 mostrados).";
      statUpdated.textContent = localTimeString(lastTs);
      gameHint.textContent = "Mini-juego activo: Bubble Pop de Aromas. Gana quien acierta m√°s aromas.";
    }

    function renderLineaRanking(results){
      setGamePill("linea");
      rankingIcon.textContent = "üìà";
      rankingTitle.textContent = "Ranking ¬∑ Test alcoholemia";
      rankingSub.textContent = "Ordenado por % medio en el tramo verde (y segundos medios como desempate).";

      tableWrap.style.display = "";
      summaryPodium.style.display = "none";

      mainMetricHead.textContent = "% medio en tramo";
      secondaryMetricHead.textContent = "Segundos medios / intentos";

      let entries = Object.entries(results || {}).map(([id, r]) => ({
        id,
        name: (r && r.name) || id,
        avgPercent: r?.avgPercent ?? 0,
        avgInsideSec: r?.avgInsideSec ?? 0,
        attempts: Array.isArray(r?.attempts) ? r.attempts.length : 0,
        ts: r?.ts ?? 0
      }));

      entries.sort((a,b)=>{
        if(b.avgPercent !== a.avgPercent) return b.avgPercent - a.avgPercent;
        if(b.avgInsideSec !== a.avgInsideSec) return b.avgInsideSec - a.avgInsideSec;
        return (b.ts||0) - (a.ts||0);
      });
      entries = entries.slice(0, 12);

      clearRanking();

      if(!entries.length){
        emptyMsg.style.display = "block";
        emptyMsg.textContent = "Todav√≠a no hay resultados guardados del Test alcoholemia.";
        statPlayers.textContent = "0";
        statWinner.textContent = "‚Äì";
        statMetricLabel.textContent = "% medio en tramo";
        statMetricValue.textContent = "‚Äì";
        statMetricHelp.textContent = "Se actualizar√° cuando haya resultados.";
        statUpdated.textContent = "‚Äì";
        gameHint.textContent = "Mini-juego activo: Test alcoholemia.";
        return;
      }

      let lastTs = 0;
      let sumPercent = 0;
      let sumInsideSec = 0;

      entries.forEach((p, idx)=>{
        const tr = document.createElement("tr");
        if(idx === 0) tr.classList.add("leader");
        tr.innerHTML = `
          <td class="td-rank">${idx === 0 ? '<span class="trophy">üèÜ</span>' : idx+1}</td>
          <td class="td-name">${p.name}</td>
          <td><strong>${p.avgPercent}%</strong> media</td>
          <td class="td-secondary">
            ‚è±Ô∏è ${p.avgInsideSec}s ¬∑ ${p.attempts} intento(s)
          </td>
        `;
        rankingBody.appendChild(tr);
        lastTs = Math.max(lastTs, p.ts || 0);
        sumPercent   += p.avgPercent   || 0;
        sumInsideSec += p.avgInsideSec || 0;
      });

      const avgPercentAll = Math.round(sumPercent / entries.length);
      const avgInsideAll  = Math.round(sumInsideSec / entries.length);

      statPlayers.textContent = String(entries.length);
      statWinner.textContent = entries[0].name;
      statMetricLabel.textContent = "% medio en tramo";
      statMetricValue.textContent = `${avgPercentAll}% ¬∑ ${avgInsideAll}s`;
      statMetricHelp.textContent = "Promedio global de % y segundos en tramo verde (top 12 mostrados).";
      statUpdated.textContent = localTimeString(lastTs);
      gameHint.textContent = "Mini-juego activo: Test alcoholemia. Gana quien mantiene mejor el punto en el tramo verde.";
    }

    // Escuchar qu√© mini-juego est√° activo
    const currentScreenRef = ref(db, "miniGames/currentScreen");
    onValue(currentScreenRef, snap => {
      const val = snap.val() || "cata";

      if(val === "bubbles"){
        attachResultsListener("bubbles");
        if(subtitleMain) subtitleMain.textContent = "Ranking en directo ¬∑ Bubble Pop de Aromas.";
      }else if(val === "linea"){
        attachResultsListener("linea");
        if(subtitleMain) subtitleMain.textContent = "Ranking en directo ¬∑ Test alcoholemia.";
      }else if(val === "summary"){
        setGamePill("summary");
        rankingIcon.textContent = "üèÅ";
        rankingTitle.textContent = "Podio final mini-juegos";
        rankingSub.textContent = "Ganadores y Top 3 de Bubble Pop y Test alcoholemia.";
        attachSummaryListenersOnce();
        renderSummaryPodium();
        if(subtitleMain) subtitleMain.textContent = "Podio final de los mini-juegos.";
      }else{
        if(currentResultsUnsub){
          currentResultsUnsub();
          currentResultsUnsub = null;
        }
        renderNoGame();
        if(subtitleMain && !tvMode){
          subtitleMain.textContent = "Ranking en directo de los invitados seg√∫n el mini-juego activo: Bubble Pop de Aromas ü´ß o Test alcoholemia üìà.";
        }
      }
    });

    // Estado inicial
    renderNoGame();
  </script>
</body>
</html>
