<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>La degustazione de Puglia ¬∑ Gorri√≥n Wine Experience</title>

  <!-- Playfair Display para t√≠tulos -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;800;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0f0f12; --bg2:#15151a;
      --card:#17181d; --soft:#20222a; --text:#f5f5f7; --muted:#b7bbc7;
      --accent:#ffb347; --accent2:#ff6f61; --ok:#9be7a1;
      --radius:18px; --shadow: 0 10px 30px rgba(0,0,0,.35);

      /* escala TV dashboard (override con ?tvscale=0.75) */
      --tv-scale: .85;

      /* altura header din√°mica */
      --header-h: 120px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(900px 500px at 10% -10%, color-mix(in oklab, var(--accent) 22%, transparent), transparent 60%),
        radial-gradient(800px 500px at 110% 0%, color-mix(in oklab, var(--accent2) 18%, transparent), transparent 60%),
        linear-gradient(180deg, var(--bg), var(--bg2));
      min-height:100vh;
      transition: background .6s ease;
    }
    body::after{
      content:""; position:fixed; inset:-10%;
      background:
        radial-gradient(2px 2px at 10% 20%, rgba(255,255,255,.05), transparent 60%),
        radial-gradient(2px 2px at 70% 80%, rgba(255,255,255,.04), transparent 60%),
        radial-gradient(1.5px 1.5px at 30% 70%, rgba(255,255,255,.04), transparent 60%);
      pointer-events:none; opacity:.6;
    }

    header{
      position:sticky; top:0; z-index:10;
      background: rgba(15,15,18,.75); backdrop-filter: blur(8px);
      border-bottom:1px solid #242633;
    }
    .wrap{max-width:980px; margin:0 auto; padding:14px 16px;}
    .brand{display:flex; align-items:center; gap:12px;}
    .logo{
      width:42px; height:42px; border-radius:12px; display:grid; place-items:center;
      background: linear-gradient(145deg, var(--accent), var(--accent2));
      color:#1a1a1a; font-weight:800; box-shadow: var(--shadow);
      flex:0 0 auto;
    }
    h1{font-size:1.15rem; margin:0}
    .sub{color:var(--muted); font-size:.9rem; margin-top:2px}

    /* Header layout base */
    .headerRow{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      width:100%;
    }
    .headerLeft{
      display:flex; align-items:center; gap:12px; min-width:0;
    }
    .headerTitle{min-width:0;}
    .headerWineInfo{
      display:none; /* se activa solo en dashboard */
      font-weight:900;
      white-space:nowrap;
      color:var(--text);
      background:#111218;
      border:1px dashed #2b2f3d;
      padding:6px 10px;
      border-radius:999px;
    }
    .headerControls{
      display:none; /* solo dashboard */
      gap:8px; align-items:center;
    }

    /* Barra de progreso en el header (solo dashboard) */
    .headerProgress{
      display:none; /* solo dashboard */
      height:8px;
      margin:8px 16px 10px;
      border-radius:999px;
      background:#222634;
      overflow:hidden;
      border:1px solid #2d3142;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.02);
    }
    .headerProgress > div{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      transition: width .6s ease;
    }

    main{padding:18px 0 28px}
    .grid{display:grid; grid-template-columns: 1.15fr .85fr; gap:16px;}
    @media (max-width: 860px){ .grid{grid-template-columns:1fr} }

    .card{
      background: color-mix(in oklab, var(--card) 92%, black);
      border:1px solid #242633; border-radius: var(--radius);
      padding:18px; box-shadow: var(--shadow);
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px; background: var(--soft);
      padding:6px 10px; border-radius:999px; color:var(--muted); font-size:.85rem;
      border:1px solid #2a2d3a;
    }
    .title{display:flex; align-items:flex-start; justify-content:space-between; gap:10px; margin-top:10px;}
    .title h2{
      margin:.2rem 0 0; font-size:1.75rem; line-height:1.15;
      font-family: "Playfair Display", serif; font-weight:900;
      letter-spacing:.2px;
    }
    .meta{color:var(--muted); font-size:.98rem}
    .badge{
      background: rgba(155,231,161,.12); color: var(--ok);
      border:1px solid rgba(155,231,161,.25);
      padding:6px 10px; border-radius: 999px; font-size:.8rem; white-space:nowrap;
    }

    .heroImg{
      width:100%; height:220px; margin-top:12px; border-radius:16px; overflow:hidden;
      border:1px solid #2a2d3a; background:#111218;
      display:block; object-fit:cover;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.02);
    }

    .story{
      margin-top:10px; padding:10px 12px; border-radius:12px;
      background: #12131a; border:1px dashed #2e3242;
      font-style: italic; color: var(--text);
    }

    /* Logo bienvenida */
    .welcomeLogoWrap{
      margin-top:16px;
      display:flex;
      justify-content:center;
    }
    .welcomeLogo{
      width:120px;
      max-width:45vw;
      border-radius:999px;
      border:2px solid #2a2d3a;
      padding:8px;
      background:#0f0f12;
      box-shadow: 0 10px 30px rgba(0,0,0,.45);
      object-fit:contain;
    }

    .section{margin-top:14px; padding-top:12px; border-top:1px dashed #2b2f3d;}
    .section h3{margin:0 0 6px; font-size:1.02rem}
    ul{margin:8px 0 0 18px;}
    li{margin:6px 0}
    .note{color:var(--muted); font-size:.98rem; line-height:1.55}

    .pairing{
      background:
        linear-gradient(180deg, color-mix(in oklab, var(--accent) 12%, transparent), transparent 70%),
        var(--soft);
      border:1px solid #2a2d3a; border-radius:14px; padding:14px; margin-top:8px;
    }
    .pairing strong{font-size:1.05rem}

    .progress{
      margin-top:12px; height:10px; border-radius:999px;
      background:#222634; overflow:hidden; border:1px solid #2d3142;
    }
    .progress > div{
      height:100%; width:0%;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      transition:width .6s ease;
    }
    .steps{display:flex; gap:6px; margin-top:10px;}
    .dot{
      flex:1; height:6px; border-radius:999px; background:#2a2e3e; overflow:hidden;
      border:1px solid #32364a;
    }
    .dot.active{
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      border-color: rgba(255,255,255,.18);
      box-shadow: 0 0 12px color-mix(in oklab, var(--accent2) 40%, transparent);
    }

    .nav{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px;}
    button{
      appearance:none; border:none; cursor:pointer; color:var(--text);
      background: var(--soft); border:1px solid #2a2d3a; padding:10px 12px;
      border-radius:12px; font-weight:800; letter-spacing:.2px;
      transition:.15s transform, .15s border, .15s background;
    }
    button:hover{transform:translateY(-1px); border-color:#3a3f52}
    button.primary{
      background: linear-gradient(145deg, #2b2f3d, #1f212b);
      border-color:#3a3f52;
    }
    button.warn{
      background: linear-gradient(145deg, #2a1f1f, #1a1414);
      border-color:#4a3030;
    }
    button.danger{
      background: linear-gradient(145deg, #3a1212, #240b0b);
      border:1px solid #6a1f1f;
      color:#ffd7d7;
      font-weight:900;
    }
    button.danger:hover{
      border-color:#8a2a2a;
      transform: translateY(-1px) scale(1.02);
    }

    .hostBox{
      margin-top:12px; padding:12px; border-radius:14px;
      background: #12131a; border:1px dashed #2e3242;
    }
    .hostTitle{font-weight:900; margin-bottom:8px}
    .input{
      width:100%; background:#0e0f14; color:var(--text);
      border:1px solid #2a2d3a; border-radius:10px; padding:10px 12px;
      font-size:1rem; outline:none;
    }
    .row{display:flex; gap:8px; margin-top:8px; flex-wrap:wrap;}

    .toggle{
      display:flex; align-items:center; gap:8px; margin-top:8px;
      font-size:.95rem; color:var(--muted);
    }
    .small{font-size:.85rem; color:var(--muted)}

    /* ‚≠ê Rating dorado (invitado) */
    .star-btn{
      background: transparent !important;
      border: none !important;
      padding: 2px 4px !important;
      font-size: 1.9rem;
      line-height: 1;
      cursor: pointer;
      color: #3b3f52;
      text-shadow: 0 2px 8px rgba(0,0,0,.35);
      transform: translateY(1px);
    }
    .star-btn:hover{ transform: translateY(0px) scale(1.05); }
    .star-btn.filled{
      color: #f6c453;
      text-shadow:
        0 0 8px rgba(246,196,83,.55),
        0 2px 10px rgba(0,0,0,.55);
    }

    /* OVERLAY show (usado por overlay vino + name gate) */
    .overlay{
      position:fixed; inset:0; z-index:999;
      display:none; place-items:center; text-align:center;
      background:
        radial-gradient(900px 500px at 50% -10%, color-mix(in oklab, var(--accent) 30%, transparent), transparent 60%),
        radial-gradient(800px 500px at 50% 110%, color-mix(in oklab, var(--accent2) 25%, transparent), transparent 60%),
        rgba(10,10,12,.92);
      backdrop-filter: blur(6px);
    }
    .overlay.show{display:grid; animation:ov .45s ease;}
    @keyframes ov{from{opacity:0; transform:scale(.98)} to{opacity:1; transform:scale(1)}}
    .ovCard{
      padding:26px 20px; border-radius:22px; border:1px solid #2a2d3a;
      background: #12131a; width:min(560px, 92vw); box-shadow: var(--shadow);
    }
    .ovBig{
      font-size:2.2rem; font-weight:900; margin:.2rem 0 .4rem;
      font-family: "Playfair Display", serif;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      -webkit-background-clip:text; background-clip:text; color:transparent;
    }
    .ovWine{font-size:1.12rem; color:var(--text); font-weight:800}
    .ovSub{color:var(--muted); margin-top:6px}

    .fade-in{animation:fade .25s ease;}
    @keyframes fade{from{opacity:0; transform:translateY(6px)} to{opacity:1; transform:none}}

    footer{color:var(--muted); font-size:.9rem; text-align:center; padding:18px}

    /* Pantalla intermedio */
    .pauseBox{
      text-align:center; padding:30px 16px;
      background:
        linear-gradient(180deg, color-mix(in oklab, var(--accent) 7%, transparent), transparent 65%),
        var(--soft);
      border:1px solid #2a2d3a; border-radius:18px;
    }
    .pauseTitle{
      font-family:"Playfair Display", serif; font-weight:900; font-size:2rem;
      margin:0 0 6px;
    }
    .pauseSub{ color:var(--muted); font-size:1.05rem; }

    /* =======================
       LISTA USUARIOS (base)
       ======================= */
    .userGrid{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
      margin-top:6px;
    }
    .userCol{
      background:#111218;
      border:1px dashed #2b2f3d;
      border-radius:12px;
      padding:8px 10px;
    }
    .userRow{
      display:flex;
      justify-content:space-between;
      gap:10px;
      padding:6px 0;
      border-bottom:1px dashed #2b2f3d;
    }
    .userRow:last-child{ border-bottom:none; }
    .userName{ font-weight:900; }
    .userRight{ white-space:nowrap; font-weight:800; }

    /* =======================
       TV LAYOUT (dashboard)
       ======================= */
    body.tv header{
      position: fixed; top:0; left:0; right:0;
      z-index: 50;
    }
    body.tv .wrap{max-width:none;}
    body.tv .headerRow{
      padding: 10px 14px;
      gap:10px;
    }

    /* üî• Header vino m√°s grande */
    body.tv .headerWineInfo{
      display:inline-flex;
      font-size: clamp(1.2rem, 2.2vw, 2.0rem);
      padding: 8px 14px;
      font-weight: 900;
      letter-spacing: .3px;
      border-width: 2px;
    }
    body.tv .headerControls{ display:flex; }
    body.tv .headerProgress{
      display:block;
      margin: 6px 14px 10px;
      height: 8px;
    }

    /* ‚úÖ Dashboard FIJO debajo del header (sin padding-top ni body-scale) */
    body.tv #dashboard.tvDash{
      position: fixed;
      top: var(--header-h);
      left: 0; right: 0; bottom: 0;
      padding: 10px 14px 12px;
      max-width: none; margin: 0;
      display: none;
    }

    /* ‚úÖ Escala SOLO el contenido del dashboard */
    body.tv #dashScale{
      transform: scale(var(--tv-scale));
      transform-origin: top left;
      width: calc(100% / var(--tv-scale));
      height: calc(100% / var(--tv-scale));
    }

    body.tv #dashGrid{
      display: grid;
      grid-template-columns: 1fr !important;
      gap: 0 !important;
      height: 100%;
    }
    body.tv #dashGrid .card{
      height: 100%;
      display: flex; flex-direction: column;
      padding: 18px 20px; border-radius: 18px;
    }

    .tvLayout{
      display: grid;
      grid-template-columns: 1.1fr 0.9fr;
      gap: 16px;
      flex: 1; min-height: 0;
      margin-top: 6px;
    }
    .tvCol{
      display: flex; flex-direction: column;
      gap: 12px; min-height: 0;
    }
    .tvBlock{
      background:#111218;
      border:1px dashed #2b2f3d;
      border-radius:14px;
      padding:12px 14px;
    }

    /* ‚úÖ Evita cortes de t√≠tulos en FireTV/Silk */
    body.tv .tvBlock h3{
      line-height: 1.25 !important;
      margin: 0 0 10px !important;
      padding-top: 2px;
      padding-bottom: 2px;
    }

    /* ‚úÖ Participantes: t√≠tulo visible + lista recortada sin scroll */
    body.tv .participantsBlock{
      display: flex;
      flex-direction: column;
      min-height: 0;
      overflow: visible;
    }
    body.tv .participantsBlock .participantsList{
      flex: 1;
      min-height: 0;
      overflow: hidden;
    }

    /* Nariz y boca en la misma l√≠nea (2 columnas) */
    body.tv .noseMouthRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:16px; align-items:start;
    }

    /* ‚≠ê Estrellas doradas en el dashboard */
    #dashboard .dashStar{
      color:#3b3f52; letter-spacing:2px;
      text-shadow:0 2px 6px rgba(0,0,0,.45);
      font-size: clamp(1.2rem, 1.8vw, 1.9rem);
    }
    #dashboard .dashStar.filled{
      color:#f6c453;
      text-shadow:
        0 0 8px rgba(246,196,83,.6),
        0 2px 10px rgba(0,0,0,.6);
    }
    #dashboard .dashStarsWrap{
      display:inline-flex; gap:2px;
      transform: translateY(2px);
    }

    /* =======================
       TV RESPONSIVE v2
       ======================= */
    body.tv{
      font-size: clamp(14px, 1.6vw, 22px);
      --p-name: clamp(1.0rem, 1.6vw, 1.7rem);
      --p-right: clamp(.9rem, 1.3vw, 1.4rem);
      --p-pad: clamp(4px, .6vw, 8px);
    }
    body.tv h3{
      font-size: clamp(1.0rem, 1.5vw, 1.6rem) !important;
      letter-spacing: .2px;
    }
    body.tv .note{
      font-size: clamp(.95rem, 1.2vw, 1.35rem);
      line-height: 1.5;
    }
    body.tv .pill{
      font-size: clamp(.8rem, 1.0vw, 1.05rem);
      padding: 5px 8px;
    }

    body.tv .participantsBlock .userRow{ padding: var(--p-pad) 0 !important; }
    body.tv .participantsBlock .userName{ font-size: var(--p-name) !important; font-weight: 900; }
    body.tv .participantsBlock .userRight{ font-size: var(--p-right) !important; font-weight: 900; white-space: nowrap; }

    body.tv .tvBlock div[style*="height:8px"]{
      height: clamp(8px, .9vw, 12px) !important;
      border-radius: 999px;
    }
    body.tv .tvBlock .small{ font-size: clamp(.75rem, .9vw, 1.0rem); }
    body.tv .card .meta{ font-size: clamp(.95rem, 1.1vw, 1.25rem) !important; }

    @media (max-width:520px){
      .headerWineInfo{display:none !important;}
    }

    /* =======================
       MODO INVITADO "PREMIUM" M√ìVIL
       ======================= */
    body.guest main{
      padding-bottom:80px; /* espacio para la barra m√≥vil */
    }
    @media (max-width: 860px){
      body.guest .grid{
        grid-template-columns:1fr;
      }
      body.guest aside.card{
        display:none; /* fuera la columna derecha en m√≥vil invitado */
      }
      body.guest #wineCard{
        border-radius:22px;
        padding-bottom:90px;
      }
      body.guest .heroImg{
        height:240px;
        border-radius:20px;
      }
    }

    .mobileBar{
      position:fixed; left:0; right:0; bottom:0;
      z-index:40;
      padding:10px 16px;
      background:rgba(10,10,14,.94);
      backdrop-filter:blur(14px);
      border-top:1px solid #262838;
      display:none;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    body.guest .mobileBar{ display:flex; }
    @media (min-width:860px){
      .mobileBar{ display:none !important; }
    }

    .mobileBarMain{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width:0;
    }
    .mobileBarTitle{
      font-size:.95rem;
      font-weight:700;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .mobileBarSub{
      font-size:.8rem;
      color:var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .mobileBarProgressWrap{
      flex:0 0 120px;
      height:6px;
      border-radius:999px;
      background:#222634;
      border:1px solid #2d3142;
      overflow:hidden;
    }
    .mobileBarProgress{
      height:100%;
      width:0%;
      background:linear-gradient(90deg,var(--accent),var(--accent2));
      transition:width .4s ease;
    }
  </style>
</head>
<body>

<header>
  <div class="wrap headerRow">
    <div class="headerLeft">
      <div class="logo">GW</div>
      <div class="headerTitle">
        <h1>La degustazione de Puglia</h1>
        <div class="sub">Vino activo sincronizado en tiempo real</div>
      </div>
    </div>

    <div id="headerWineInfo" class="headerWineInfo"></div>

    <div class="headerControls">
      <button id="fsBtn" class="primary" style="padding:8px 10px; border-radius:10px;">‚õ∂ Fullscreen</button>
    </div>
  </div>

  <div id="headerProgress" class="headerProgress">
    <div id="headerProgressBar"></div>
  </div>
</header>

<!-- DASHBOARD (TV) -->
<section id="dashboard" class="wrap tvDash">
  <div id="dashScale">
    <div id="dashGrid"></div>
  </div>
</section>

<main class="wrap">
  <div class="grid">
    <section id="wineCard" class="card fade-in"></section>

    <aside class="card">
      <div id="statusWrap">
        <div class="pill">Estado</div>
        <div id="status" class="note" style="margin-top:8px">Conectando‚Ä¶</div>

        <div class="toggle">
          <input id="soundToggle" type="checkbox" />
          <label for="soundToggle">Sonido al cambiar vino</label>
        </div>
      </div>

      <div id="hostPanel" class="hostBox" style="display:none">
        <div class="hostTitle">Modo Host</div>

        <div class="section" style="margin-top:10px; padding-top:10px;">
          <h3 style="margin:0 0 6px; font-size:1rem;">üë• Participantes esperados</h3>
          <div class="row" style="align-items:center;">
            <input id="expectedInput" type="number" min="1" max="50"
                   class="input" style="max-width:140px"
                   placeholder="12" />
            <button id="setExpectedBtn" class="primary">Guardar</button>
          </div>
          <div class="small" id="expectedHint" style="margin-top:6px; opacity:.9;">
            El dashboard mostrar√° el quiz cuando hayan respondido todos.
          </div>
        </div>

        <div class="row">
          <button id="welcomeBtn">üé¨ Bienvenida</button>
          <button id="prevBtn">‚Üê Anterior</button>
          <button id="nextBtn" class="primary">Siguiente ‚Üí</button>
          <button id="pauseBtn" class="warn">‚è∏ Intermedio</button>
        </div>
        <div id="hostButtons" class="nav"></div>

        <div class="row" style="margin-top:10px">
          <button id="resetDbBtn" class="danger">üß® Resetear DB (borrar votos)</button>
        </div>
        <div class="small" style="margin-top:6px; opacity:.9">
          Esto borra ratings, quiz, nariz, boca y acciones. No borra tus vinos.
        </div>

        <div style="margin-top:10px; font-weight:800;">Nota del host (sale en todos)</div>
        <input id="hostNoteInput" class="input" placeholder="Ej: Fijaos en la acidez y el toque salino‚Ä¶" />
        <div class="row">
          <button id="sendNote" class="primary">Publicar nota</button>
          <button id="clearNote">Borrar nota</button>
        </div>
        <div class="small" style="margin-top:6px">URL host: a√±ade <b>?host=1</b></div>
      </div>

      <div id="orderSection" class="section">
        <h3>Orden de servicio</h3>
        <ol class="note" id="orderList" style="margin-left:18px"></ol>
      </div>
    </aside>
  </div>
</main>

<footer>üç∑ Buona cata! ¬∑ Gorri√≥n Wine Experience ¬∑ La degustazione de Puglia</footer>

<div id="overlay" class="overlay">
  <div class="ovCard">
    <div class="pill" style="justify-content:center">Ahora servimos</div>
    <div id="ovBig" class="ovBig">Vino 1</div>
    <div id="ovWine" class="ovWine">Nombre del vino</div>
    <div id="ovSub" class="ovSub">Prep√°rate para el maridaje‚Ä¶</div>
  </div>
</div>

<div id="nameGate" class="overlay">
  <div class="ovCard" style="text-align:left">
    <div class="pill">Bienvenido/a</div>
    <div class="ovBig" style="font-size:1.8rem; margin-top:.4rem;">Antes de entrar‚Ä¶</div>
    <div class="note" style="margin-top:6px">
      Escribe tu nombre o apodo para identificar tus votos.
    </div>

    <input id="nameInput" class="input" maxlength="30"
           placeholder="Tu nombre / apodo" style="margin-top:10px"/>

    <div class="row" style="margin-top:10px">
      <button id="enterBtn" class="primary" disabled>Entrar a la cata</button>
    </div>

    <div class="small" style="margin-top:8px">
      (No pedimos email ni datos personales.)
    </div>
  </div>
</div>

<!-- Barra m√≥vil premium invitado -->
<div id="mobileBar" class="mobileBar">
  <div class="mobileBarMain">
    <div id="mobileBarTitle" class="mobileBarTitle">La degustazione de Puglia</div>
    <div id="mobileBarSub" class="mobileBarSub">Tu mando de la cata</div>
  </div>
  <div class="mobileBarProgressWrap">
    <div id="mobileBarProgress" class="mobileBarProgress"></div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
  import { getDatabase, ref, onValue, set, update, runTransaction } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-database.js";

  // üî• CONFIG REAL
  const firebaseConfig = {
    apiKey: "AIzaSyDwlXwWlmgLhwgjONXQmWE7O5H54aZd6dk",
    authDomain: "catas-9d780.firebaseapp.com",
    databaseURL: "https://catas-9d780-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "catas-9d780",
    storageBucket: "catas-9d780.firebasestorage.app",
    messagingSenderId: "554356727364",
    appId: "1:554356727364:web:2e8a754067872751efa611",
    measurementId: "G-F2YRVJ9B00"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  const wines = [
    {
      id: 1,
      name: "Favugn√´ Falanghina Bianco 2024",
      winery: "Cantine Teanum",
      type: "Blanco ¬∑ inicio fresco",
      story: "Cap√≠tulo 1: brisa c√≠trica del Adri√°tico para abrir la mesa.",
      notes: [
        "Perfil c√≠trico y floral, boca ligera con buena acidez.",
        "Ideal para abrir la cata con una sensaci√≥n mediterr√°nea."
      ],
      pairing: {
        name: "Tosta mediterr√°nea sobre Torta de In√©s Rosales salada con romero",
        desc: "Burrata + lim√≥n confitado + anchoa + pistacho. Cremoso, salino y c√≠trico."
      },
      serve: "8‚Äì10 ¬∫C ¬∑ copa blanca",
      quiz: {
        q: "La Falanghina suele destacar sobre todo por‚Ä¶",
        options: ["Notas ahumadas", "Perfil c√≠trico y floral", "Tanino potente"],
        correct: 1
      }
    },
    {
      id: 2,
      name: "Montepulciano d‚ÄôAbruzzo Riserva",
      winery: "Terre della Brunda",
      type: "Tinto reserva",
      story: "Cap√≠tulo 2: fruta negra y especias, el vino se pone serio.",
      notes: [
        "Estructura, fruta negra y especias.",
        "Paso serio pero redondo."
      ],
      pairing: {
        name: "Mini-picaditas de ma√≠z con ricotta y nduja",
        desc: "Cherry asados y albahaca. Grasa + picante suave."
      },
      serve: "16‚Äì18 ¬∫C ¬∑ copa bal√≥n",
      quiz: {
        q: "¬øCon qu√© va mejor este Riserva?",
        options: ["Bocado graso y picante suave", "Postre de chocolate", "Ensalada c√≠trica"],
        correct: 0
      }
    },
    {
      id: 3,
      name: "Triplico Multiplo 2023",
      winery: "Botter",
      type: "Tinto joven ¬∑ cierre amable",
      story: "Cap√≠tulo 3: pausa frutal, sonrisa f√°cil entre platos.",
      notes: [
        "Frutal y directo, tanino amable.",
        "Descanso sabroso tras los vinos serios."
      ],
      pairing: {
        name: "Spezzatino ligero de ternera con alubias blancas",
        desc: "Cucharada corta con romero."
      },
      serve: "15‚Äì17 ¬∫C",
      quiz: {
        q: "Este vino es m√°s bien‚Ä¶",
        options: ["Joven y frutal", "Muy t√°nico y duro", "Oxidativo"],
        correct: 0
      }
    },
    {
      id: 4,
      name: "Lupo Meraviglia Tre di Tre 2023",
      winery: "Botter",
      type: "Tinto estructurado",
      story: "Cap√≠tulo 4: estructura y salsa, aqu√≠ manda el guiso.",
      notes: [
        "Cuerpo medio-alto, fruta madura, toque bals√°mico.",
        "Pide bocado con salsa."
      ],
      pairing: {
        name: "Canel√≥n de carrilleras con reducci√≥n",
        desc: "Peque√±o pero intenso, umami y salsa ligada."
      },
      serve: "16‚Äì18 ¬∫C",
      quiz: {
        q: "¬øQu√© pide este vino?",
        options: ["Plato con salsa/umami", "Solo frutos secos", "Nada de comida"],
        correct: 0
      }
    },
    {
      id: 5,
      name: "Cinquenoci Primitivo 2023",
      winery: "Tagaro",
      type: "Tinto c√°lido y frutal",
      story: "Cap√≠tulo 5: cielo rojo de Puglia, cierre c√°lido y largo.",
      notes: [
        "Fruta roja madura, especias dulces, final envolvente.",
        "Cierre potente y muy Puglia."
      ],
      pairing: {
        name: "Butifarra al vino con patatas y tomillo",
        desc: "Mordisco jugoso y salsa concentrada."
      },
      serve: "17‚Äì18 ¬∫C",
      quiz: {
        q: "¬øQu√© sensaci√≥n es t√≠pica del Primitivo?",
        options: ["Frescura ligera", "Calidez y fruta madura", "Acidez punzante extrema"],
        correct: 1
      }
    }
  ];

  const themes = {
    0:{accent:"#b7bbc7", accent2:"#6b7280", bg:"#0c0d10", bg2:"#14161b"},
    1:{accent:"#ffd166", accent2:"#6ee7ff", bg:"#0d0f12", bg2:"#14202a"},
    2:{accent:"#ff8fab", accent2:"#ffb703", bg:"#100b10", bg2:"#211716"},
    3:{accent:"#b8f2a5", accent2:"#9bb7ff", bg:"#0d1110", bg2:"#18221e"},
    4:{accent:"#fbbf24", accent2:"#fb7185", bg:"#0f0d10", bg2:"#231a1d"},
    5:{accent:"#ff6f61", accent2:"#c084fc", bg:"#0f0a0a", bg2:"#1f1216"},
  };

  const wineCard    = document.getElementById("wineCard");
  const statusEl    = document.getElementById("status");
  const orderList   = document.getElementById("orderList");
  const hostPanel   = document.getElementById("hostPanel");
  const hostButtons = document.getElementById("hostButtons");
  const prevBtn     = document.getElementById("prevBtn");
  const nextBtn     = document.getElementById("nextBtn");
  const pauseBtn    = document.getElementById("pauseBtn");
  const welcomeBtn  = document.getElementById("welcomeBtn");
  const noteInput   = document.getElementById("hostNoteInput");
  const sendNoteBtn = document.getElementById("sendNote");

  const overlay     = document.getElementById("overlay");
  const ovBig       = document.getElementById("ovBig");
  const ovWine      = document.getElementById("ovWine");
  const ovSub       = document.getElementById("ovSub");

  const mobileBar          = document.getElementById("mobileBar");
  const mobileBarTitle     = document.getElementById("mobileBarTitle");
  const mobileBarSub       = document.getElementById("mobileBarSub");
  const mobileBarProgress  = document.getElementById("mobileBarProgress");

  const soundToggle = document.getElementById("soundToggle");
  if(soundToggle){
    soundToggle.checked = localStorage.getItem("gw_sound") === "1";
    soundToggle.onchange = () => localStorage.setItem("gw_sound", soundToggle.checked ? "1":"0");
  }

  const qs = new URLSearchParams(location.search);
  const isHost = qs.get("host") === "1";
  const isDashboard = qs.get("dashboard") === "1";

  // FireTV/Silk escala SOLO dashboard
  if (isDashboard) {
    const tvScaleParam = parseFloat(qs.get("tvscale"));
    if (!isNaN(tvScaleParam) && tvScaleParam > 0.5 && tvScaleParam < 1.2) {
      document.documentElement.style.setProperty("--tv-scale", String(tvScaleParam));
    }
  }

  // Marca cuerpo como invitado (no host, no dashboard)
  if(!isHost && !isDashboard){
    document.body.classList.add("guest");
  }

  if(!isHost && !isDashboard){
    const sw = document.getElementById("statusWrap");
    if(sw) sw.style.display = "none";
    const os = document.getElementById("orderSection");
    if(os) os.style.display = "none";
  }

  // ===== üë§ IDENTIFICACI√ìN SIMPLE (OBLIGATORIA) =====
  let guestName = (localStorage.getItem("gw_name") || "").trim();

  function showNameGate(){
    const gate = document.getElementById("nameGate");
    const input = document.getElementById("nameInput");
    const btn = document.getElementById("enterBtn");

    gate.classList.add("show");
    document.body.style.overflow = "hidden";

    const syncBtn = () => { btn.disabled = input.value.trim().length === 0; };
    input.addEventListener("input", syncBtn);
    syncBtn();
    input.focus();

    btn.onclick = () => {
      const n = input.value.trim();
      if(!n) return;
      guestName = n.slice(0, 30);
      localStorage.setItem("gw_name", guestName);
      gate.classList.remove("show");
      document.body.style.overflow = "";
    };
  }

  if(!isHost && !isDashboard){
    if(!guestName) showNameGate();
  }else{
    guestName = isHost ? "Host" : "Dashboard";
  }

  function getDeviceId(){
    let id = localStorage.getItem("gw_device");
    if(!id){
      if(crypto?.randomUUID) id = crypto.randomUUID();
      else id = "dev_" + Math.random().toString(36).slice(2) + Date.now();
      localStorage.setItem("gw_device", id);
    }
    return id;
  }
  const deviceId = getDeviceId();
  // ===============================================

  function setTheme(id){
    const t = themes[id] || themes[1];
    document.documentElement.style.setProperty("--accent", t.accent);
    document.documentElement.style.setProperty("--accent2", t.accent2);
    document.documentElement.style.setProperty("--bg", t.bg);
    document.documentElement.style.setProperty("--bg2", t.bg2);
  }

  function renderOrder(){
    if(!orderList) return;
    orderList.innerHTML = wines.map(w =>
      `<li>${w.id}. ${w.name} ‚Äì ${w.type}</li>`
    ).join("");
  }

  function progressPercent(activeId){
    if(activeId <= 1) return 0;
    return (activeId-1)/(wines.length-1)*100;
  }

  function imageForMaridaje(id){
    const n = String(id).padStart(2, "0");
    return `img/maridaje-${n}.jpg`;
  }

  const noteTags = [
    "C√≠trico üçã","Floral üå∏","Fruta roja üçí","Fruta negra üçá","Herb√°ceo üåø",
    "Especias üå∂Ô∏è","Madera / vainilla üå≥","Mineral / salino üßÇ",
    "Tostado / caf√© üç´‚òï","Terroso / cuero üçÑ"
  ];
  function notesLSKey(wineId){ return `gw_notes_${wineId}`; }

  const mouthTags = [
    "Seco / nada dulce üßä","Goloso / frutal üç¨","Acidez alta üçã","Acidez suave üôÇ",
    "Tanino suave ü§ù","Tanino intenso üò¨","Cuerpo ligero üí®","Cuerpo potente üèãÔ∏è",
    "Cremoso / untuoso ü•õ","Final largo ‚è≥"
  ];
  function mouthLSKey(wineId){ return `gw_mouth_${wineId}`; }

  function ratingLSKey(id){ return `gw_rating_${id}`; }

  function computeRatingStats(ratingsForWine = {}){
    let total = 0, sum = 0;
    for(let s=1; s<=5; s++){
      const c = ratingsForWine[s] || 0;
      total += c;
      sum += s * c;
    }
    const avg = total ? (sum/total) : 0;
    return { total, avg };
  }

  function renderRatingSection(w, ratingsMap = {}){
    const userRating = Number(localStorage.getItem(ratingLSKey(w.id)) || 0);
    const stats = computeRatingStats(ratingsMap[w.id] || {});
    const avgTxt = stats.avg ? stats.avg.toFixed(1) : "‚Äî";

    const stars = [1,2,3,4,5].map(s=>{
      const filled = userRating >= s;
      return `<button data-rating="${s}" class="star-btn ${filled ? "filled" : ""}">‚òÖ</button>`;
    }).join("");

    return `
      <div class="section">
        <h3>¬øCu√°nto te gusta este vino?</h3>
        <div id="starsWrap" class="nav" style="gap:6px; margin-top:8px">
          ${stars}
        </div>
        <div class="note" style="margin-top:6px">
          Media del grupo: <b>${avgTxt}</b> / 5 ¬∑ votos: <b>${stats.total}</b>
        </div>
        <div class="small">Puedes cambiar tu valoraci√≥n cuando quieras.</div>
      </div>
    `;
  }

  function attachRatingHandlers(w){
    const wrap = document.getElementById("starsWrap");
    if(!wrap) return;

    wrap.querySelectorAll("button[data-rating]").forEach(btn=>{
      btn.onclick = () => {
        const newR = Number(btn.getAttribute("data-rating"));
        const oldR = Number(localStorage.getItem(ratingLSKey(w.id)) || 0);
        if(newR === oldR) return;

        localStorage.setItem(ratingLSKey(w.id), String(newR));

        if(oldR > 0){
          const oldRef = ref(db, `ratings/${w.id}/${oldR}`);
          runTransaction(oldRef, (cur)=> Math.max(0, (cur||0) - 1));
        }

        const newRef = ref(db, `ratings/${w.id}/${newR}`);
        runTransaction(newRef, (cur)=> (cur||0) + 1);

        const actionRef = ref(db, `userActions/${w.id}/${deviceId}`);
        update(actionRef, { name: guestName, rating: newR, ts: Date.now() });
      };
    });
  }

  function quizKey(id){ return `gw_quiz_${id}`; }

  function renderQuizSection(w, quizCounts=[0,0,0], hostNote=""){
    const answeredOption = localStorage.getItem(quizKey(w.id));
    const totalAnswers = quizCounts.reduce((a,b)=>a+b,0) || 1;

    const quizButtons = w.quiz.options.map((opt, i)=>{
      const isAnswered = answeredOption !== null;
      const isThis = answeredOption == i;
      const pct = Math.round((quizCounts[i]/totalAnswers)*100);

      return `
        <button data-quiz="${i}" class="${isThis ? "primary" : ""}"
          ${isAnswered ? "disabled style='opacity:.7; cursor:default'" : ""}>
          ${opt} ${isAnswered ? ` ¬∑ ${pct}%` : ""}
        </button>
      `;
    }).join("");

    return `
      <div class="section">
        <h3>Mini-quiz</h3>
        <div class="pairing" style="margin-top:6px">
          <strong>‚ùì ${w.quiz.q}</strong>
          <div id="quizBtns" class="nav" style="margin-top:8px">
            ${quizButtons}
          </div>
          <div class="small" style="margin-top:6px">
            ${answeredOption !== null
              ? (Number(answeredOption) === w.quiz.correct
                  ? "‚úÖ Correcto. ¬°Buena nariz!"
                  : `üëÄ Interesante‚Ä¶ la respuesta m√°s t√≠pica es: ‚Äú${w.quiz.options[w.quiz.correct]}‚Äù.`)
              : "Elige una opci√≥n para ver resultados en vivo."
            }
          </div>
        </div>

        ${hostNote ? `<div style="margin-top:10px" class="note">üó£Ô∏è Nota del host: <b>${hostNote}</b></div>` : ``}
      </div>
    `;
  }

  function attachQuizHandlers(w){
    const quizBtnsWrap = document.getElementById("quizBtns");
    if(quizBtnsWrap){
      quizBtnsWrap.querySelectorAll("button[data-quiz]").forEach(btn=>{
        btn.onclick = () => {
          const opt = btn.getAttribute("data-quiz");
          if(localStorage.getItem(quizKey(w.id)) !== null) return;
          localStorage.setItem(quizKey(w.id), String(opt));

          const qRef = ref(db, `quiz/${w.id}/${opt}`);
          runTransaction(qRef, (cur)=> (cur || 0) + 1);

          const actionRef = ref(db, `userActions/${w.id}/${deviceId}`);
          update(actionRef, { name: guestName, quizAnswer: Number(opt), ts: Date.now() });
        };
      });
    }
  }

  function renderNotesSection(w, notesMap = {}){
    let selected = [];
    try { selected = JSON.parse(localStorage.getItem(notesLSKey(w.id)) || "[]"); }
    catch(e){ selected = []; }

    const countsByTag = notesMap[w.id] || {};
    const totalMarks = Object.values(countsByTag).reduce((a,b)=>a+(b||0),0) || 1;

    const pills = noteTags.map((tag, idx)=>{
      const count = countsByTag[idx] || 0;
      const pct = Math.round((count / totalMarks) * 100);
      const isOn = selected.includes(idx);

      return `
        <button class="${isOn ? "primary" : ""}" data-note-idx="${idx}">
          ${tag}
          <span class="small"> ¬∑ ${pct}%</span>
        </button>
      `;
    }).join("");

    return `
      <div class="section">
        <h3>üëÉ Notas en nariz</h3>
        <div id="notesPills" class="nav" style="margin-top:8px">
          ${pills}
        </div>
        <div class="small" style="margin-top:6px">
          Marca todas las que te encajen. Los porcentajes se actualizan en vivo.
        </div>
      </div>
    `;
  }

  function attachNotesHandlers(w){
    const wrap = document.getElementById("notesPills");
    if(!wrap) return;

    function getSelected(){
      try { return JSON.parse(localStorage.getItem(notesLSKey(w.id)) || "[]"); }
      catch(e){ return []; }
    }
    function setSelected(arr){
      localStorage.setItem(notesLSKey(w.id), JSON.stringify(arr));
    }

    wrap.querySelectorAll("button[data-note-idx]").forEach(btn=>{
      btn.onclick = () => {
        const idx = Number(btn.getAttribute("data-note-idx"));
        let selected = getSelected();

        const isOn = selected.includes(idx);
        if(isOn) selected = selected.filter(x=>x!==idx);
        else selected.push(idx);
        setSelected(selected);

        const tagRef = ref(db, `notes/${w.id}/${idx}`);
        runTransaction(tagRef, (cur)=>{
          const val = cur || 0;
          const nextVal = isOn ? val - 1 : val + 1;
          return Math.max(0, nextVal);
        });

        const actionRef = ref(db, `userActions/${w.id}/${deviceId}`);
        update(actionRef, { name: guestName, notesSelected: selected, ts: Date.now() });
      };
    });
  }

  function renderMouthSection(w, mouthMap = {}){
    let selected = [];
    try { selected = JSON.parse(localStorage.getItem(mouthLSKey(w.id)) || "[]"); }
    catch(e){ selected = []; }

    const countsByTag = mouthMap[w.id] || {};
    const totalMarks = Object.values(countsByTag).reduce((a,b)=>a+(b||0),0) || 1;

    const pills = mouthTags.map((tag, idx)=>{
      const count = countsByTag[idx] || 0;
      const pct = Math.round((count / totalMarks) * 100);
      const isOn = selected.includes(idx);

      return `
        <button class="${isOn ? "primary" : ""}" data-mouth-idx="${idx}">
          ${tag}
          <span class="small"> ¬∑ ${pct}%</span>
        </button>
      `;
    }).join("");

    return `
      <div class="section">
        <h3>üëÑ Sensaciones en boca</h3>
        <div id="mouthPills" class="nav" style="margin-top:8px">
          ${pills}
        </div>
        <div class="small" style="margin-top:6px">
          Marca todas las que te encajen. Se actualiza en vivo.
        </div>
      </div>
    `;
  }

  function attachMouthHandlers(w){
    const wrap = document.getElementById("mouthPills");
    if(!wrap) return;

    function getSelected(){
      try { return JSON.parse(localStorage.getItem(mouthLSKey(w.id)) || "[]"); }
      catch(e){ return []; }
    }
    function setSelected(arr){
      localStorage.setItem(mouthLSKey(w.id), JSON.stringify(arr));
    }

    wrap.querySelectorAll("button[data-mouth-idx]").forEach(btn=>{
      btn.onclick = () => {
        const idx = Number(btn.getAttribute("data-mouth-idx"));
        let selected = getSelected();

        const isOn = selected.includes(idx);
        if(isOn) selected = selected.filter(x=>x!==idx);
        else selected.push(idx);
        setSelected(selected);

        const tagRef = ref(db, `mouth/${w.id}/${idx}`);
        runTransaction(tagRef, (cur)=>{
          const val = cur || 0;
          const nextVal = isOn ? val - 1 : val + 1;
          return Math.max(0, nextVal);
        });

        const actionRef = ref(db, `userActions/${w.id}/${deviceId}`);
        update(actionRef, { name: guestName, mouthSelected: selected, ts: Date.now() });
      };
    });
  }

  // üåü Bienvenida sincronizada
  function renderWelcome(hostNote){
    wineCard.innerHTML = `
      <div class="pill">Bienvenida</div>

      <div class="title" style="margin-top:14px;">
        <div>
          <h2>La degustazione de Puglia</h2>
          <div class="meta">5 vinos ¬∑ 5 bocados ¬∑ 1 viaje por el tac√≥n de Italia</div>
        </div>
      </div>

      <div class="welcomeLogoWrap">
        <img
          src="img/logoredondo.png"
          alt="Gorri√≥n Wine Experience"
          class="welcomeLogo"
        />
      </div>

      <div class="story" style="margin-top:14px">
        üç∑ Hoy viajamos a Puglia copa a copa. Este es tu mando de la cata:
        desde aqu√≠ puntuar√°s cada vino, marcar√°s lo que percibes y jugar√°s
        a un mini-quiz en tiempo real con el resto del grupo.
      </div>

      <div class="section">
        <h3>Antes de empezar</h3>
        <ul>
          <li>Comprueba que tienes tu copa (o copas) a mano y algo de agua.</li>
          <li>Ten cerca los bocados de maridaje para cuando llegue su vino.</li>
          <li>Aseg√∫rate de que tu m√≥vil tiene internet y algo de bater√≠a.</li>
        </ul>
      </div>

      <div class="section">
        <h3>C√≥mo usar esta pantalla</h3>
        <ul>
          <li>Cuando el host active un vino, su ficha aparecer√° aqu√≠.</li>
          <li>Dale de 1 a 5 estrellas seg√∫n cu√°nto te guste.</li>
          <li>Marca los aromas en nariz y sensaciones en boca que notes.</li>
          <li>Responde al mini-quiz: ver√°s las respuestas del grupo al momento.</li>
        </ul>
        <div class="note" style="margin-top:6px">
          Tus votos se suman a los de los dem√°s y se ven en la pantalla grande
          del evento. Puedes ajustar tu puntuaci√≥n si cambias de opini√≥n.
        </div>
      </div>

      ${hostNote ? `
        <div class="section">
          <h3>Mensaje del host</h3>
          <div class="note">üó£Ô∏è ${hostNote}</div>
        </div>
      ` : ``}
    `;
  }

  function renderPause(hostNote){
    wineCard.innerHTML = `
      <div class="pill">Intermedio</div>
      <div class="pauseBox" style="margin-top:12px">
        <h2 class="pauseTitle">Pausa Mediterr√°nea</h2>
        <div class="pauseSub">Agua ¬∑ pan ¬∑ charla ¬∑ prep√°rate para el siguiente vino</div>
        ${hostNote ? `<div class="story" style="margin-top:14px">üó£Ô∏è ${hostNote}</div>` : ``}
      </div>
      <div class="section">
        <h3>Orden de servicio</h3>
        <div class="note">Seguimos en breve con el siguiente cap√≠tulo de Puglia.</div>
      </div>
    `;
  }

  const headerWineInfo = document.getElementById("headerWineInfo");
  const headerProgressBar = document.getElementById("headerProgressBar");

  function updateHeaderWine(activeId){
    if(!isDashboard) return;

    if(activeId === -1){
      if(headerWineInfo) headerWineInfo.textContent = "üé¨ Bienvenida";
      if(headerProgressBar) headerProgressBar.style.width = "0%";
      return;
    }
    if(activeId === 0){
      if(headerWineInfo) headerWineInfo.textContent = "‚è∏ Intermedio";
      if(headerProgressBar) headerProgressBar.style.width = "0%";
      return;
    }
    const w = wines.find(x=>x.id===activeId) || wines[0];
    if(headerWineInfo) headerWineInfo.textContent = `üç∑ Vino ${w.id}/${wines.length} ¬∑ ${w.name}`;

    const pct = progressPercent(w.id);
    if(headerProgressBar) headerProgressBar.style.width = pct + "%";
  }

  function renderWine(activeId, hostNote, ratingsMap={}, quizMap={}, notesMap={}, mouthMap={}){
    const w = wines.find(x=>x.id===activeId) || wines[0];
    wineCard.classList.remove("fade-in"); void wineCard.offsetWidth; wineCard.classList.add("fade-in");

    const quizCounts = [
      (quizMap[w.id]?.[0] || 0),
      (quizMap[w.id]?.[1] || 0),
      (quizMap[w.id]?.[2] || 0)
    ];

    wineCard.innerHTML = `
      <div class="pill">Vino activo ${w.id} / ${wines.length}</div>

      <div class="title">
        <div>
          <h2>${w.name}</h2>
          <div class="meta">${w.winery} ¬∑ ${w.type}</div>
        </div>
        <div class="badge">${w.serve}</div>
      </div>

      <img class="heroImg" src="${imageForMaridaje(w.id)}" alt="Maridaje ${w.id}" />

      ${w.story ? `<div class="story">üçá ${w.story}</div>` : ``}

      <div class="progress"><div style="width:${progressPercent(w.id)}%"></div></div>
      <div class="steps">
        ${wines.map(v=>`<div class="dot ${v.id===w.id?'active':''}"></div>`).join("")}
      </div>

      <div class="section">
        <h3>Notas r√°pidas</h3>
        <ul>${w.notes.map(n=>`<li>${n}</li>`).join("")}</ul>
      </div>

      <div class="section">
        <h3>Maridaje</h3>
        <div class="pairing">
          <strong>üçΩÔ∏è ${w.pairing.name}</strong>
          <div class="note" style="margin-top:6px">${w.pairing.desc}</div>
        </div>
      </div>

      ${renderRatingSection(w, ratingsMap)}
      ${renderQuizSection(w, quizCounts, hostNote)}
      ${renderNotesSection(w, notesMap)}
      ${renderMouthSection(w, mouthMap)}
    `;

    attachRatingHandlers(w);
    attachQuizHandlers(w);
    attachNotesHandlers(w);
    attachMouthHandlers(w);
  }

  function chime(){
    if(localStorage.getItem("gw_sound")!=="1") return;
    try{
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.connect(g); g.connect(ctx.destination);
      o.type="sine"; o.frequency.value=880;
      g.gain.setValueAtTime(0.0001, ctx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.08, ctx.currentTime+0.02);
      g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+0.35);
      o.start(); o.stop(ctx.currentTime+0.4);
    }catch(e){}
  }

  function showOverlayFor(activeId){
    if(activeId === -1){
      ovBig.textContent = `Bienvenida`;
      ovWine.textContent = `La degustazione de Puglia`;
      ovSub.textContent = `Prepara la copa, servimos enseguida‚Ä¶`;
    }else if(activeId === 0){
      ovBig.textContent = `Intermedio`;
      ovWine.textContent = `Pausa Mediterr√°nea`;
      ovSub.textContent = `Agua ¬∑ pan ¬∑ charla`;
    }else{
      const w = wines.find(x=>x.id===activeId) || wines[0];
      ovBig.textContent = `Vino ${w.id}`;
      ovWine.textContent = w.name;
      ovSub.textContent = w.pairing.name;
    }
    overlay.classList.add("show");
    setTimeout(()=>overlay.classList.remove("show"), 2200);
  }

  function setupHostUI(){
    if(!isHost) return;
    hostPanel.style.display = "block";
    hostButtons.innerHTML = "";

    wines.forEach(w=>{
      const b = document.createElement("button");
      b.textContent = `${w.id}. ${w.name.split(" ")[0]}`;
      b.onclick = () => set(ref(db, "activeWine"), w.id);
      hostButtons.appendChild(b);
    });

    // üé¨ Bot√≥n Bienvenida
    if(welcomeBtn){
      welcomeBtn.onclick = () => set(ref(db, "activeWine"), -1);
    }

    // Secuencia circular: -1 ‚Üí 1 ‚Üí 2 ‚Üí 3 ‚Üí 4 ‚Üí 5 ‚Üí 0 ‚Üí -1 ‚Ä¶
    prevBtn.onclick = () => {
      const cur = window.__activeWine ?? -1;
      let next;
      if(cur === -1)        next = 0;
      else if(cur === 0)    next = wines.length;
      else if(cur === 1)    next = -1;
      else                  next = cur - 1;
      set(ref(db,"activeWine"), next);
    };
    nextBtn.onclick = () => {
      const cur = window.__activeWine ?? -1;
      let next;
      if(cur === -1)                next = 1;
      else if(cur === wines.length) next = 0;
      else if(cur === 0)            next = -1;
      else                          next = cur + 1;
      set(ref(db,"activeWine"), next);
    };
    pauseBtn.onclick = () => set(ref(db,"activeWine"), 0);

    const clearNoteBtn= document.getElementById("clearNote");
    if(sendNoteBtn){
      sendNoteBtn.onclick = () => {
        const v = noteInput.value.trim();
        update(ref(db,"/"), { hostNote: v });
      };
    }
    if(clearNoteBtn){
      clearNoteBtn.onclick = () => {
        noteInput.value="";
        update(ref(db,"/"), { hostNote: "" });
      };
    }

    const expectedInput = document.getElementById("expectedInput");
    const setExpectedBtn = document.getElementById("setExpectedBtn");
    const expectedHint = document.getElementById("expectedHint");

    onValue(ref(db, "expectedUsers"), (s)=>{
      const val = s.val();
      if(expectedInput && val){
        expectedInput.value = val;
        if(expectedHint) expectedHint.textContent = `Ahora mismo esperas ${val} participantes.`;
      }
    });

    if(setExpectedBtn){
      setExpectedBtn.onclick = () => {
        const n = Number(expectedInput.value || 0);
        if(!n || n < 1) return;
        update(ref(db, "/"), { expectedUsers: n });
        if(expectedHint) expectedHint.textContent = `Guardado: esperas ${n} participantes.`;
      };
    }

    const resetDbBtn = document.getElementById("resetDbBtn");
    if(resetDbBtn){
      resetDbBtn.onclick = async () => {
        const ok = confirm(
          "‚ö†Ô∏è Vas a borrar TODAS las puntuaciones y respuestas.\n\n" +
          "Esto no se puede deshacer.\n\n" +
          "¬øSeguro que quieres resetear la base de datos?"
        );
        if(!ok) return;

        const expectedUsers = Number(expectedInput?.value || 12);

        await set(ref(db, "/"), {
          activeWine: -1,
          hostNote: "",
          expectedUsers,
          ratings: {},
          quiz: {},
          notes: {},
          mouth: {},
          userActions: {}
        });

        alert("‚úÖ DB reseteada. Todo vuelve a 0.");
      };
    }
  }

  // ===== DASHBOARD MODE =====
  const dashGrid= document.getElementById("dashGrid");

  function ratingHistogramHTML(rForWine = {}){
    const max = Math.max(...[1,2,3,4,5].map(s => rForWine[s] || 0), 1);
    return [5,4,3,2,1].map(s=>{
      const c = rForWine[s] || 0;
      const w = Math.round((c/max)*100);
      return `
        <div style="display:grid; grid-template-columns:28px 1fr 34px; gap:8px; align-items:center; margin:6px 0;">
          <div style="font-weight:900">${s}‚òÖ</div>
          <div style="height:8px; background:#2a2e3e; border-radius:999px; overflow:hidden; border:1px solid #32364a;">
            <div style="height:100%; width:${w}%; background:linear-gradient(90deg,var(--accent),var(--accent2));"></div>
          </div>
          <div class="small" style="text-align:right">${c}</div>
        </div>
      `;
    }).join("");
  }

  function topNotesHTML(notesForWine = {}){
    const pairs = Object.entries(notesForWine)
      .map(([k,v]) => ({ idx:Number(k), count: v||0 }))
      .sort((a,b)=>b.count-a.count)
      .slice(0,3);

    if(!pairs.length || pairs[0].count===0) return `<div class="small">Sin datos a√∫n</div>`;

    const total = Object.values(notesForWine).reduce((a,b)=>a+(b||0),0) || 1;

    return pairs.map(p=>{
      const pct = Math.round((p.count/total)*100);
      return `<div class="note">‚Ä¢ ${mouthTags ? noteTags[p.idx] : ""} <span class="small">(${pct}%)</span></div>`;
    }).join("");
  }

  function topMouthHTML(mouthForWine = {}){
    const pairs = Object.entries(mouthForWine)
      .map(([k,v]) => ({ idx:Number(k), count: v||0 }))
      .sort((a,b)=>b.count-a.count)
      .slice(0,3);

    if(!pairs.length || pairs[0].count===0) return `<div class="small">Sin datos a√∫n</div>`;

    const total = Object.values(mouthForWine).reduce((a,b)=>a+(b||0),0) || 1;

    return pairs.map(p=>{
      const pct = Math.round((p.count/total)*100);
      return `<div class="note">‚Ä¢ ${mouthTags[p.idx]} <span class="small">(${pct}%)</span></div>`;
    }).join("");
  }

  function quizSummaryHTML(w, quizForWine = {}){
    if(!w.quiz) return `<div class="small">Sin quiz</div>`;
    const counts = [
      quizForWine[0]||0,
      quizForWine[1]||0,
      quizForWine[2]||0
    ];
    const total = counts.reduce((a,b)=>a+b,0) || 1;

    return w.quiz.options.map((opt,i)=>{
      const pct = Math.round((counts[i]/total)*100);
      const isCorrect = i===w.quiz.correct;
      return `
        <div class="note" style="${isCorrect?'font-weight:900;color:var(--ok)':''}">
          ‚Ä¢ ${opt} <span class="small">(${pct}%)</span> ${isCorrect?'‚úì':''}
        </div>
      `;
    }).join("");
  }

  function quizCorrectStats(w, quizForWine = {}){
    if(!w.quiz) return { correct: 0, total: 0, pct: 0 };
    const counts = [
      quizForWine[0]||0,
      quizForWine[1]||0,
      quizForWine[2]||0
    ];
    const total = counts.reduce((a,b)=>a+b,0) || 0;
    const correct = counts[w.quiz.correct] || 0;
    const pct = total ? Math.round((correct/total)*100) : 0;
    return { correct, total, pct };
  }

  function userListHTML(wineId, actionsForWine = {}){
    const ww = wines.find(x=>x.id===wineId);

    function emojiOnly(tag){
      if(!tag) return "";
      const em = tag.match(/[\p{Extended_Pictographic}]/gu);
      return em ? em.join("") : tag;
    }

    const entries = Object.values(actionsForWine || {})
      .map(a => {
        const rating = a?.rating || 0;
        const qa = (a?.quizAnswer ?? null);
        const isCorrect =
          (ww && qa !== null && typeof ww.quiz?.correct === "number")
            ? (Number(qa) === ww.quiz.correct)
            : null;

        const selNotes = Array.isArray(a?.notesSelected) ? a.notesSelected : [];
        const top2Notes = selNotes.slice(0,2).map(i => emojiOnly(noteTags[i])).join(" ");

        const selMouth = Array.isArray(a?.mouthSelected) ? a.mouthSelected : [];
        const top2Mouth = selMouth.slice(0,2).map(i => emojiOnly(mouthTags[i])).join(" ");

        return {
          name: a?.name || "Invitado",
          rating,
          isCorrect,
          top2Notes,
          top2Mouth,
          ts: a?.ts || 0
        };
      })
      .sort((a,b)=>b.ts-a.ts)
      .slice(0,12);

    if(!entries.length) return `<div class="small">A√∫n no hay participaciones.</div>`;

    const rows = entries.map(e=>{
      const stars = e.rating
        ? `<span class="dashStarsWrap">${
            Array.from({length:5}, (_,i)=>
              `<span class="dashStar ${i < e.rating ? "filled" : ""}">‚òÖ</span>`
            ).join("")
          }</span>`
        : "‚Äî";

      const quizMark =
        e.isCorrect === null ? "‚Äî" : (e.isCorrect ? "‚úÖ" : "‚ùå");

      return `
        <div class="userRow">
          <div class="userName">${e.name}</div>
          <div class="userRight">
            ${stars} ¬∑ ${quizMark}
            ${e.top2Notes ? `¬∑ ${e.top2Notes}` : ""}
            ${e.top2Mouth ? `¬∑ ${e.top2Mouth}` : ""}
          </div>
        </div>
      `;
    }).join("");

    return `
      <div class="userGrid">
        <div class="userCol">
          ${rows}
        </div>
      </div>
    `;
  }

  function fitParticipants(expectedUsers){
    if(!isDashboard) return;
    const factor = Math.max(0.78, Math.min(1.12, 10 / expectedUsers));
    document.body.style.setProperty("--p-name",  `clamp(${1.0*factor}rem, ${1.6*factor}vw, ${1.7*factor}rem)`);
    document.body.style.setProperty("--p-right", `clamp(${0.9*factor}rem, ${1.3*factor}vw, ${1.4*factor}rem)`);
    document.body.style.setProperty("--p-pad",   `clamp(${4*factor}px,  ${0.6*factor}vw, ${8*factor}px)`);
  }

  function renderDashboard(activeId, ratingsMap={}, quizMap={}, notesMap={}, mouthMap={}, userActionsMap={}, expectedCount=12){
    if(!dashGrid) return;

    if(activeId === -1){
      dashGrid.innerHTML = `
        <div class="card">
          <div class="pill">Bienvenida</div>
          <div style="margin-top:6px; font-weight:900; font-size:2.2rem; font-family:'Playfair Display', serif;">
            La degustazione de Puglia
          </div>

          <div class="welcomeLogoWrap">
            <img
              src="img/logoredondo.png"
              alt="Gorri√≥n Wine Experience"
              class="welcomeLogo"
            />
          </div>

          <div class="note" style="margin-top:12px">
            El host a√∫n no ha activado el primer vino. Acom√≥date, sirve agua y revisa tu ficha de cata.
          </div>

          <div class="section" style="margin-top:14px; padding-top:12px; border-top:1px dashed #2b2f3d;">
            <h3>Orden de servicio</h3>
            <ol class="note" style="margin-left:18px">
              ${wines.map(w=>`<li>${w.id}. ${w.name} ‚Äì ${w.type}</li>`).join("")}
            </ol>
          </div>
        </div>
      `;
      return;
    }

    if(activeId === 0){
      dashGrid.innerHTML = `
        <div class="card">
          <div class="pill">Intermedio</div>
          <div style="margin-top:6px; font-weight:900; font-size:2.2rem; font-family:'Playfair Display', serif;">
            Pausa Mediterr√°nea
          </div>
          <div class="note" style="margin-top:8px">
            Ahora mismo no hay vino activo.
          </div>
        </div>
      `;
      return;
    }

    const w = wines.find(x=>x.id===activeId) || wines[0];
    const rForWine = ratingsMap[w.id] || {};
    const stats = computeRatingStats(rForWine);
    const qsLocal = quizCorrectStats(w, quizMap[w.id] || {});

    const actionsForWine = userActionsMap[w.id] || {};
    const participants = Object.keys(actionsForWine).length;
    const quizAnswered = Object.values(actionsForWine)
      .filter(a => a && a.quizAnswer !== undefined && a.quizAnswer !== null).length;

    const showQuiz = quizAnswered >= expectedCount;

    dashGrid.innerHTML = `
      <div class="card">
        <div class="tvLayout">

          <div class="tvCol">
            <div class="tvBlock participantsBlock" style="flex:1;">
              <h3>üë• Participantes (${participants}/${expectedCount})</h3>
              <div class="participantsList">
                ${userListHTML(w.id, actionsForWine)}
              </div>
            </div>
          </div>

          <div class="tvCol">

            <div class="tvBlock">
              <h3>‚≠ê Valoraci√≥n</h3>
              <div class="note" style="margin-bottom:8px">
                Media: <b>${stats.avg ? stats.avg.toFixed(1) : "‚Äî"}</b> / 5 ¬∑ votos: <b>${stats.total}</b>
              </div>
              ${ratingHistogramHTML(rForWine)}
            </div>

            <div class="tvBlock">
              <div class="noseMouthRow">
                <div>
                  <h3 style="margin-bottom:6px">üëÉ Nariz (top 3)</h3>
                  ${topNotesHTML(notesMap[w.id] || {})}
                </div>
                <div>
                  <h3 style="margin-bottom:6px">üëÑ Boca (top 3)</h3>
                  ${topMouthHTML(mouthMap[w.id] || {})}
                </div>
              </div>
            </div>

            <div class="tvBlock">
              <h3>‚ùì Quiz</h3>
              ${showQuiz ? `
                <div class="note" style="margin-bottom:8px">
                  Aciertos: <b>${qsLocal.correct}</b> / ${qsLocal.total}
                  <span class="small">(${qsLocal.pct}%)</span>
                </div>
                ${quizSummaryHTML(w, quizMap[w.id] || {})}
              ` : `
                <div class="note">
                  Esperando respuestas‚Ä¶ <b>${quizAnswered}/${expectedCount}</b>
                </div>
                <div class="small" style="margin-top:8px">
                  El quiz se mostrar√° cuando hayan respondido todos.
                </div>
              `}
            </div>

          </div>
        </div>
      </div>
    `;
  }

  function toggleDashboardUI(){
    if(!isDashboard) return;
    const mainWrap = document.querySelector("main.wrap");
    if(mainWrap) mainWrap.style.display = "none";
    const dashEl = document.getElementById("dashboard");
    if(dashEl) dashEl.style.display = "block";
    document.body.classList.add("tv");
  }
  toggleDashboardUI();

  // ‚úÖ mide header real y fija dashboard debajo SIEMPRE
  function syncHeaderHeight(){
    if(!isDashboard) return;
    const headerEl = document.querySelector("header");
    const h = headerEl ? headerEl.offsetHeight : 120;
    document.documentElement.style.setProperty("--header-h", h + "px");
  }
  window.addEventListener("load", syncHeaderHeight);
  window.addEventListener("resize", syncHeaderHeight);
  setTimeout(syncHeaderHeight, 250);

  function setupFullscreenBtn(){
    if(!isDashboard) return;
    const fsBtn = document.getElementById("fsBtn");
    if(!fsBtn) return;

    const docEl = document.documentElement;

    function isFs(){
      return document.fullscreenElement ||
             document.webkitFullscreenElement ||
             document.mozFullScreenElement ||
             document.msFullscreenElement;
    }

    async function enterFs(){
      try{
        if(docEl.requestFullscreen) await docEl.requestFullscreen();
        else if(docEl.webkitRequestFullscreen) await docEl.webkitRequestFullscreen();
        else if(docEl.mozRequestFullScreen) await docEl.mozRequestFullScreen();
        else if(docEl.msRequestFullscreen) await docEl.msRequestFullscreen();
      }catch(e){}
    }

    async function exitFs(){
      try{
        if(document.exitFullscreen) await document.exitFullscreen();
        else if(document.webkitExitFullscreen) await document.webkitExitFullscreen();
        else if(document.mozCancelFullScreen) await document.mozCancelFullScreen();
        else if(document.msExitFullscreen) await document.msRequestFullscreen();
      }catch(e){}
    }

    fsBtn.onclick = async () => {
      if(isFs()) await exitFs();
      else await enterFs();
    };

    function updateLabel(){
      fsBtn.textContent = isFs() ? "‚õ∂ Salir" : "‚õ∂ Fullscreen";
    }

    document.addEventListener("fullscreenchange", updateLabel);
    document.addEventListener("webkitfullscreenchange", updateLabel);
    updateLabel();
  }
  setupFullscreenBtn();

  function updateMobileBar(activeId){
    if(!mobileBar || !document.body.classList.contains("guest")) return;

    if(activeId === -1){
      mobileBarTitle.textContent = "Esperando al inicio";
      mobileBarSub.textContent = "El host activar√° el primer vino en breve";
      mobileBarProgress.style.width = "0%";
    }else if(activeId === 0){
      mobileBarTitle.textContent = "Intermedio activo";
      mobileBarSub.textContent = "Agua ¬∑ pan ¬∑ charla";
      mobileBarProgress.style.width = "0%";
    }else{
      const w = wines.find(x=>x.id===activeId) || wines[0];
      mobileBarTitle.textContent = `Vino ${w.id} de ${wines.length}`;
      mobileBarSub.textContent = w.name;
      mobileBarProgress.style.width = progressPercent(w.id) + "%";
    }
  }

  const rootRef = ref(db, "/");
  let lastWine = null;

  onValue(rootRef, (snap)=>{
    const data = snap.val() || {};
    const activeId      = data.activeWine ?? -1;
    const hostNote      = data.hostNote || "";
    const expectedUsers = data.expectedUsers ?? 12;

    const ratingsMap    = data.ratings || {};
    const quizMap       = data.quiz  || {};
    const notesMap      = data.notes || {};
    const mouthMap      = data.mouth || {};
    const userActionsMap= data.userActions || {};

    updateHeaderWine(activeId);

    if(isDashboard){
      syncHeaderHeight();
      fitParticipants(expectedUsers);
      renderDashboard(activeId, ratingsMap, quizMap, notesMap, mouthMap, userActionsMap, expectedUsers);
      return;
    }

    window.__activeWine = activeId;

    // Bienvenida / intermedio usan el tema 0, los vinos su propio tema
    const themeId = activeId <= 0 ? 0 : activeId;
    setTheme(themeId);

    if(activeId === -1){
      if(statusEl) statusEl.textContent = `Pantalla de bienvenida activa.`;
      renderWelcome(hostNote);
    }else if(activeId === 0){
      if(statusEl) statusEl.textContent = `Intermedio activo.`;
      renderPause(hostNote);
    }else{
      if(statusEl) statusEl.textContent = `Mostrando vino ${activeId}. Sincronizado en tiempo real.`;
      renderWine(activeId, hostNote, ratingsMap, quizMap, notesMap, mouthMap);
    }

    updateMobileBar(activeId);

    if(lastWine !== null && lastWine !== activeId){
      showOverlayFor(activeId);
      chime();
    }
    lastWine = activeId;

  }, (err)=>{
    if(statusEl) statusEl.textContent = "Error de conexi√≥n a Firebase.";
    console.error(err);
  });

  if(isHost){
    onValue(rootRef, (snap)=>{
      if(snap.val() == null){
        set(rootRef, {
          activeWine: -1,
          hostNote: "",
          expectedUsers: 12,
          ratings: {},
          quiz: {},
          notes: {},
          mouth: {},
          userActions: {}
        });
      }
    }, { onlyOnce:true });
  }

  renderOrder();
  setupHostUI();
</script>

</body>
</html>
