<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Bubble Pop de Aromas ¬∑ Demo Mobile</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />

  <style>
    :root{
      --bg:#040712;
      --bg2:#090d18;
      --card:#121626;
      --accent:#6ee7ff;
      --accent2:#ff6f61;
      --ok:#9be7a1;
      --error:#ff8b94;
      --text:#f5f5f7;
      --muted:#b7bbc7;
      --radius:18px;
      --shadow:0 10px 30px rgba(0,0,0,.45);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      min-height:100vh;
      font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
      background:
        radial-gradient(900px 500px at 10% -10%, color-mix(in oklab, var(--accent) 22%, transparent), transparent 60%),
        radial-gradient(800px 500px at 110% 0%, color-mix(in oklab, var(--accent2) 18%, transparent), transparent 60%),
        linear-gradient(180deg, var(--bg), var(--bg2));
      color:var(--text);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:16px;
      -webkit-tap-highlight-color: transparent;
    }
    .shell{
      width:100%;
      max-width:420px;
    }
    .card{
      background:color-mix(in oklab, var(--card) 92%, black);
      border-radius:var(--radius);
      padding:14px 14px 16px;
      box-shadow:var(--shadow);
      border:1px solid #252942;
    }
    .header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .titleWrap{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    h1{
      font-size:1.3rem;
      letter-spacing:.04em;
      text-transform:uppercase;
    }
    .subtitle{
      font-size:.82rem;
      color:var(--muted);
    }
    .pill-row{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:10px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:4px 8px;
      border-radius:999px;
      font-size:.78rem;
      background:#101628;
      border:1px solid #323b5a;
      color:var(--muted);
      white-space:nowrap;
    }
    .pill b{color:var(--text);}

    /* fila de selecci√≥n de vino */
    .wine-row{
      margin-top:10px;
      display:flex;
      align-items:flex-start;
      gap:8px;
    }
    .wine-select{
      flex:1;
      border-radius:999px;
      border:1px solid #2f3854;
      background:#0c1222;
      color:var(--text);
      padding:6px 10px;
      font-size:.85rem;
      outline:none;
    }
    .wine-select:disabled{
      opacity:.6;
    }
    .wine-info{
      font-size:.78rem;
      color:var(--muted);
      line-height:1.35;
      margin-top:4px;
    }

    .tag{
      display:inline-flex;
      align-items:center;
      gap:4px;
      font-size:.78rem;
      border-radius:999px;
      padding:4px 8px;
      background:#111827;
      border:1px solid #30374f;
      margin-top:6px;
    }
    .tag span{
      opacity:.8;
    }

    /* Playfield + HUD */
    .play-wrap{
      margin-top:12px;
      background:#050814;
      border-radius:var(--radius);
      border:1px solid #22273c;
      padding:10px;
      position:relative;
      overflow:hidden;
    }
    .hud{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      font-size:.8rem;
      margin-bottom:6px;
    }
    .hud-left{
      display:flex;
      gap:6px;
      align-items:center;
    }
    .hud-chip{
      padding:3px 8px;
      border-radius:999px;
      background:#101828;
      border:1px solid #31374f;
      font-size:.78rem;
    }
    .hud-chip strong{
      color:var(--accent);
    }
    .timer{
      font-variant-numeric:tabular-nums;
      font-weight:700;
    }

    .score-box{
      display:flex;
      gap:6px;
      font-size:.8rem;
    }
    .score-chip{
      padding:3px 7px;
      border-radius:999px;
      border:1px solid #31374f;
      background:#0b1020;
      display:flex;
      align-items:center;
      gap:4px;
    }
    .score-chip.good{color:var(--ok);}
    .score-chip.bad{color:var(--error);}

    #playfield{
      position:relative;
      height:260px;
      border-radius:14px;
      background:
        radial-gradient(circle at 20% 0%, rgba(255,255,255,.08), transparent 60%),
        radial-gradient(circle at 80% 100%, rgba(255,255,255,.04), transparent 55%),
        linear-gradient(180deg,#050813,#050814);
      overflow:hidden;
      border:1px solid #252b44;
      touch-action:none;
    }

    .bubble{
      position:absolute;
      width:52px;
      height:52px;
      border-radius:999px;
      background:radial-gradient(circle at 30% 20%, rgba(255,255,255,.9), rgba(255,255,255,.05));
      border:1px solid rgba(255,255,255,.6);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:4px;
      text-align:center;
      font-size:.7rem;
      color:#050814;
      box-shadow:0 8px 18px rgba(0,0,0,.65);
      cursor:pointer;
      user-select:none;
    }
    .bubble.good{
      box-shadow:0 0 0 1px rgba(255,255,255,.5),0 10px 18px rgba(0,0,0,.7);
    }
    .bubble.bad{
      opacity:.85;
    }
    .bubble.pop{
      animation:pop .18s ease-out forwards;
    }

    @keyframes pop{
      0%{transform:scale(1);opacity:1;}
      100%{transform:scale(1.35);opacity:0;}
    }

    .status{
      margin-top:8px;
      font-size:.8rem;
      color:var(--muted);
      min-height:28px;
    }

    .btn-row{
      margin-top:10px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    button{
      border:none;
      border-radius:999px;
      padding:7px 12px;
      font-size:.82rem;
      font-weight:600;
      letter-spacing:.03em;
      text-transform:uppercase;
      cursor:pointer;
      background:#111827;
      color:var(--text);
      border:1px solid #2f3852;
    }
    button.primary{
      background:linear-gradient(135deg,var(--accent),var(--accent2));
      color:#051018;
      border:none;
      box-shadow:0 8px 16px rgba(0,0,0,.5);
    }
    button:disabled{
      opacity:.55;
      cursor:default;
    }

    .bubble-legend{
      margin-top:12px;
      padding:8px;
      border-radius:14px;
      background:#050a17;
      border:1px dashed #313854;
      font-size:.78rem;
      color:var(--muted);
    }
    .bubble-legend b{color:var(--text);}
    .legend-row{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:6px;
    }
    .legend-pill{
      padding:4px 7px;
      border-radius:999px;
      border:1px solid #303854;
      background:#080d1e;
      font-size:.76rem;
    }

    .toast{
      position:fixed;
      left:50%;
      bottom:16px;
      transform:translateX(-50%) translateY(120%);
      background:#020617;
      border-radius:999px;
      padding:7px 12px;
      font-size:.8rem;
      color:var(--text);
      border:1px solid #303753;
      box-shadow:0 10px 22px rgba(0,0,0,.65);
      opacity:0;
      pointer-events:none;
      transition:transform .22s ease-out,opacity .22s ease-out;
      z-index:40;
    }
    .toast.show{
      transform:translateX(-50%) translateY(0%);
      opacity:1;
    }

    /* Overlay final */
    .overlay{
      position:fixed;
      inset:0;
      background:rgba(3,6,18,.92);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:16px;
      opacity:0;
      pointer-events:none;
      transition:opacity .25s ease-out;
      z-index:30;
    }
    .overlay.show{
      opacity:1;
      pointer-events:auto;
    }
    .overlay-card{
      max-width:420px;
      width:100%;
      background:#050816;
      border-radius:var(--radius);
      border:1px solid #323853;
      padding:14px 14px 16px;
      box-shadow:0 18px 40px rgba(0,0,0,.85);
    }
    .overlay-header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:8px;
    }
    .overlay-title{
      font-size:1.05rem;
      font-weight:700;
    }
    .overlay-sub{
      font-size:.8rem;
      color:var(--muted);
      margin-top:4px;
    }
    .overlay-body{
      margin-top:10px;
      font-size:.84rem;
      line-height:1.45;
    }
    .overlay-body b{color:var(--text);}
    .overlay-actions{
      margin-top:12px;
      display:flex;
      justify-content:flex-end;
      gap:8px;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:3px 7px;
      border-radius:999px;
      border:1px solid #31374f;
      font-size:.75rem;
      background:#050a18;
      color:var(--muted);
    }
    .chip.good{color:var(--ok);}
    .chip.bad{color:var(--error);}
    .overlay .small{
      font-size:.78rem;
      color:var(--muted);
      margin-top:6px;
    }

    @media (min-height:700px){
      #playfield{height:280px;}
    }
  </style>
</head>
<body>
  <div class="shell">
    <div class="card">
      <div class="header">
        <div class="titleWrap">
          <h1>Bubble Pop de Aromas</h1>
          <div class="subtitle">
            Revienta solo las burbujas con aromas que vayan bien con cada vino. ü´ßüç∑
          </div>
        </div>
      </div>

      <div class="pill-row">
        <div class="pill"><b>Objetivo:</b> seleccionar los aromas que mejor representan el vino.</div>
        <div class="pill"><b>Toques:</b> apunta bien, cada toque cuenta.</div>
      </div>

      <div class="wine-row">
        <div style="flex:1;">
          <select id="wineSelect" class="wine-select">
            <option value="falanghina">1 ¬∑ Favugn√´ Falanghina Bianco</option>
            <option value="montepulciano">2 ¬∑ Montepulciano d‚ÄôAbruzzo Riserva</option>
            <option value="lupo">3 ¬∑ Lupo Meraviglia Tre di Tre</option>
            <option value="cinquenoci">4 ¬∑ Cinquenoci Primitivo</option>
            <option value="triplico">5 ¬∑ Triplico Multiplo</option>
          </select>
          <div id="wineInfo" class="wine-info">
            Blanco fresco con notas c√≠tricas, florales y toque mineral. Ideal para aromas ligeros y vibrantes.
          </div>
          <div id="wineTags" class="tag">
            <span>üéØ Aromas clave:</span>
            <b>C√≠trico, floral, mineral, fruta blanca</b>
          </div>
        </div>
      </div>

      <div class="play-wrap">
        <div class="hud">
          <div class="hud-left">
            <div class="hud-chip">
              Vino actual: <strong id="wineShort">Falanghina</strong>
            </div>
            <div class="hud-chip">
              Tiempo: <span id="timer" class="timer">00:30</span>
            </div>
          </div>
          <div class="score-box">
            <div class="score-chip good">‚úÖ Aciertos: <span id="score">0</span></div>
            <div class="score-chip bad">‚ùå Fallos: <span id="mistakes">0</span></div>
            <div class="score-chip">üí® Escapan: <span id="missed">0</span></div>
          </div>
        </div>

        <div id="playfield"></div>

        <div id="statusText" class="status">
          Pulsa ‚ÄúEmpezar‚Äù y revienta solo las burbujas con aromas que encajen con el vino seleccionado.
        </div>

        <div class="btn-row">
          <button id="startBtn" class="primary">Empezar partida</button>
          <button id="hintBtn">Ver pista de aromas</button>
        </div>
      </div>

      <div class="bubble-legend">
        <b>C√≥mo funciona:</b><br>
        Cada burbuja tiene un aroma. Toca solo los que encajen bien con el vino (c√≠trico, floral, mineral‚Ä¶). Si revientas una burbuja equivocada, cuenta como fallo.
        <div class="legend-row">
          <div class="legend-pill">ü´ß Buena burbuja = aroma correcto</div>
          <div class="legend-pill">ü´ß Burbuja trampa = aroma que no va con el vino</div>
          <div class="legend-pill">üí® Cuando suben y se van, cuenta como ‚Äúescapan‚Äù.</div>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <div id="endOverlay" class="overlay">
    <div class="overlay-card">
      <div class="overlay-header">
        <div>
          <div class="overlay-title">Fin de la partida</div>
          <div class="overlay-sub">
            Resumen de tu Bubble Pop de Aromas.
          </div>
        </div>
        <div class="chip">ü´ß Aromas</div>
      </div>
      <div class="overlay-body" id="finalStats">
        <!-- resumen se inyecta por JS -->
      </div>
      <div class="overlay-actions">
        <button id="closeOverlayBtn">Cerrar</button>
        <button id="restartOverlayBtn" class="primary">Jugar con otro vino</button>
      </div>
      <div class="small">
        <div class="chip good">‚úÖ Aciertos = burbujas de aroma correcto</div>
        <div class="chip bad">‚ùå Fallos = burbujas que no encajaban con el vino</div>
      </div>
    </div>
  </div>

  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
  import { getDatabase, ref, onValue, set } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDwlXwWlmgLhwgjONXQmWE7O5H54aZd6dk",
    authDomain: "catas-9d780.firebaseapp.com",
    databaseURL: "https://catas-9d780-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "catas-9d780",
    storageBucket: "catas-9d780.firebasestorage.app",
    messagingSenderId: "554356727364",
    appId: "1:554356727364:web:2e8a754067872751efa611",
    measurementId: "G-F2YRVJ9B00"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  const rawName = (localStorage.getItem("gw_name") || "INVITADO").toUpperCase().slice(0, 8);
  const sessionId = rawName || "INVITADO";

  const qs = new URLSearchParams(location.search);
  const isHost = qs.get("host") === "1";
  const isDashboard = qs.get("dashboard") === "1";

  // Invitados: seguir miniGames/currentScreen
  if(!isHost && !isDashboard){
    const screenRef = ref(db, "miniGames/currentScreen");
    onValue(screenRef, (snap) => {
      const screen = snap.val() || "cata";
      const current = (location.pathname.split("/").pop() || "").toLowerCase();

      if(screen === "cata"){
        if(current !== "index.html"){
          window.location.href = "index.html";
        }
      }else if(screen === "bubbles"){
        // Nos quedamos en Bubble Pop
        return;
      }else if(screen === "linea"){
        if(!current.includes("linea")){
          window.location.href = "linea.html";
        }
      }
    });
  }

  (function(){
  const playfield = document.getElementById("playfield");
  const startBtn = document.getElementById("startBtn");
  const hintBtn = document.getElementById("hintBtn");
  const statusText = document.getElementById("statusText");
  const scoreEl = document.getElementById("score");
  const mistakesEl = document.getElementById("mistakes");
  const missedEl = document.getElementById("missed");
  const timerEl = document.getElementById("timer");
  const wineSelect = document.getElementById("wineSelect");
  const wineInfoEl = document.getElementById("wineInfo");
  const wineTagsEl = document.getElementById("wineTags");
  const wineShortEl = document.getElementById("wineShort");

  const endOverlay = document.getElementById("endOverlay");
  const finalStatsEl = document.getElementById("finalStats");
  const closeOverlayBtn = document.getElementById("closeOverlayBtn");
  const restartOverlayBtn = document.getElementById("restartOverlayBtn");
  const toastEl = document.getElementById("toast");

  const GAME_DURATION_MS = 30000;
  const SPAWN_INTERVAL_SEC = 0.7;
  const SPEED_PX_PER_SEC = 95;

  const WINE_ORDER = ["falanghina","montepulciano","lupo","cinquenoci","triplico"];

  const wines = {
    falanghina: {
      id: "falanghina",
      short: "Falanghina",
      color: "blanco",
      grapes: "Falanghina",
      goodKeys: ["citrico","floral","mineral","fruta_blanca"],
      description: "Blanco fresco, c√≠trico y floral, con toque mineral y fruta blanca.",
      tags: "C√≠trico, floral, mineral, fruta blanca"
    },
    montepulciano: {
      id: "montepulciano",
      short: "Montepulciano",
      color: "tinto",
      grapes: "Montepulciano d‚ÄôAbruzzo",
      goodKeys: ["fruta_negra","mermelada","especia_dulce","hierbas"],
      description: "Tinto reserva con fruta negra, especias dulces y toque de hierbas mediterr√°neas.",
      tags: "Fruta negra, mermelada, especia dulce, hierbas"
    },
    lupo: {
      id: "lupo",
      short: "Lupo Meraviglia",
      color: "tinto",
      grapes: "Negroamaro, Malvasia Nera",
      goodKeys: ["fruta_negra","mermelada","chocolate","cafe"],
      description: "Tinto potente y estructurado, con capas de fruta negra, mermelada y notas de cacao/tostado.",
      tags: "Fruta negra, mermelada, chocolate, caf√©/tostado"
    },
    cinquenoci: {
      id: "cinquenoci",
      short: "Cinquenoci",
      color: "tinto",
      grapes: "Primitivo",
      goodKeys: ["fruta_roja","fruta_negra","mermelada","especia_dulce","caramelo"],
      description: "Primitivo c√°lido, frutal y algo goloso, con fruta roja/negra, mermelada y especia dulce.",
      tags: "Fruta roja, fruta negra, mermelada, especia dulce, caramelo"
    },
    triplico: {
      id: "triplico",
      short: "Triplico Multiplo",
      color: "tinto",
      grapes: "Blend tinto",
      goodKeys: ["fruta_roja","fruta_negra","hierbas","especia_dulce"],
      description: "Tinto joven y amable, con fruta roja/negra, toque de hierbas y especia dulce suave.",
      tags: "Fruta roja, fruta negra, hierbas mediterr√°neas, especia suave"
    }
  };

  const aromaPool = [
    { label:"C√≠trico üçã", key:"citrico" },
    { label:"Floral üå∏", key:"floral" },
    { label:"Salino / mineral üßÇ", key:"mineral" },
    { label:"Fruta blanca üçè", key:"fruta_blanca" },
    { label:"Fruta roja üçì", key:"fruta_roja" },
    { label:"Fruta negra üçá", key:"fruta_negra" },
    { label:"Mermelada / compota üçí", key:"mermelada" },
    { label:"Especia dulce üå∂Ô∏è", key:"especia_dulce" },
    { label:"Hierbas mediterr√°neas üåø", key:"hierbas" },
    { label:"Chocolate üç´", key:"chocolate" },
    { label:"Caf√© / tostado ‚òï", key:"cafe" },
    { label:"Vainilla üç®", key:"vainilla" },
    { label:"Caramelo üç¨", key:"caramelo" },
    { label:"Mantequilla üßà", key:"mantequilla" },
    { label:"Pan tostado ü•ñ", key:"tostado_pan" },
    { label:"Pimienta negra ‚ö´", key:"pimienta" },
    { label:"Humo / ahumado üî•", key:"ahumado" }
  ];

  let bubbles = [];
  let gameRunning = false;
  let lastFrameTime = null;
  let remainingMs = GAME_DURATION_MS;
  let spawnAccumulator = 0;

  let score = 0;
  let mistakes = 0;
  let missed = 0;

  let currentWineId = "falanghina";
  let wineResults = {};
  let winePlayed = {
    falanghina:false,
    montepulciano:false,
    lupo:false,
    cinquenoci:false,
    triplico:false
  };

  function showToast(msg){
    toastEl.textContent = msg;
    toastEl.classList.add("show");
    clearTimeout(showToast._t);
    showToast._t = setTimeout(()=>{
      toastEl.classList.remove("show");
    }, 2200);
  }

  function formatTime(ms){
    const t = Math.max(0, Math.floor(ms / 1000));
    const s = t % 60;
    const m = Math.floor(t / 60);
    const ss = String(s).padStart(2,"0");
    const mm = String(m).padStart(2,"0");
    return `${mm}:${ss}`;
  }

  function getActiveWine(){
    return wines[currentWineId];
  }

  function updateWineUI(){
    const w = getActiveWine();
    wineShortEl.textContent = w.short;
    wineInfoEl.textContent = w.description;
    wineTagsEl.innerHTML = `
      <span>üéØ Aromas clave:</span>
      <b>${w.tags}</b>
    `;
  }

  function resetCounters(){
    score = 0;
    mistakes = 0;
    missed = 0;
    scoreEl.textContent = "0";
    mistakesEl.textContent = "0";
    missedEl.textContent = "0";
  }

  function spawnBubble(){
    const w = getActiveWine();
    if(!w) return;

    const isGood = Math.random() < 0.6;
    const goodList = aromaPool.filter(a => w.goodKeys.includes(a.key));
    const badList  = aromaPool.filter(a => !w.goodKeys.includes(a.key));

    let chosen;
    if(isGood && goodList.length){
      chosen = goodList[Math.floor(Math.random()*goodList.length)];
    }else if(badList.length){
      chosen = badList[Math.floor(Math.random()*badList.length)];
    }else if(goodList.length){
      chosen = goodList[Math.floor(Math.random()*goodList.length)];
    }else{
      return;
    }

    const bubble = document.createElement("div");
    bubble.className = "bubble" + (w.goodKeys.includes(chosen.key) ? " good" : " bad");
    bubble.textContent = chosen.label;
    bubble.dataset.key = chosen.key;
    bubble.dataset.good = w.goodKeys.includes(chosen.key) ? "1" : "0";

    const fieldRect = playfield.getBoundingClientRect();
    const margin = 10;
    const x = margin + Math.random()*(fieldRect.width - margin*2 - 52);
    const startY = fieldRect.height + 10;

    bubble.style.left = x + "px";
    bubble.style.top  = startY + "px";

    bubble.__y = startY;
    bubble.__speed = SPEED_PX_PER_SEC * (0.9 + Math.random()*0.3);

    bubble.addEventListener("pointerdown", (ev)=>{
      ev.preventDefault();
      if(!gameRunning) return;
      const isGood = bubble.dataset.good === "1";

      if(isGood){
        score++;
        scoreEl.textContent = String(score);
        showToast("‚úÖ Aroma acertado para el vino");
      }else{
        mistakes++;
        mistakesEl.textContent = String(mistakes);
        showToast("‚ùå Ese aroma no encaja con el vino");
      }

      bubble.classList.add("pop");
      setTimeout(()=>{
        if(playfield.contains(bubble)){
          playfield.removeChild(bubble);
        }
      }, 150);
      bubbles = bubbles.filter(b => b !== bubble);
    });

    playfield.appendChild(bubble);
    bubbles.push(bubble);
  }

  function clearBubbles(){
    bubbles.forEach(b => {
      if(playfield.contains(b)){
        playfield.removeChild(b);
      }
    });
    bubbles = [];
  }

  function endGame(){
    gameRunning = false;
    lastFrameTime = null;

    wineSelect.disabled = false;
    timerEl.textContent = "00:00";

    const totalTouches = score + mistakes;
    const accuracy = totalTouches ? Math.round((score / totalTouches) * 100) : 0;
    const activeWine = getActiveWine();

    // guardar resultados de este vino
    wineResults[currentWineId] = {
      score,
      mistakes,
      missed,
      accuracy
    };

    // nuevo: subir resultados agregados de esta sesi√≥n a Firebase
    try{
      if(typeof db !== "undefined"){
        const all = Object.values(wineResults || {});
        const winesPlayed = all.length;
        let totalScore = 0;
        let totalMistakes = 0;
        let totalMissed = 0;
        let sumAccuracy = 0;
        all.forEach(r => {
          if(!r) return;
          totalScore    += r.score    || 0;
          totalMistakes += r.mistakes || 0;
          totalMissed   += r.missed   || 0;
          sumAccuracy   += r.accuracy || 0;
        });
        const avgAccuracy = winesPlayed ? Math.round(sumAccuracy / winesPlayed) : 0;

        const safeId = sessionId || "INVITADO";
        const resultsRef = ref(db, "miniGames/bubbles/results/" + safeId);
        const payload = {
          sessionId: safeId,
          name: safeId,
          ts: Date.now(),
          winesPlayed,
          totalScore,
          totalMistakes,
          totalMissed,
          avgAccuracy,
          perWine: wineResults
        };
        set(resultsRef, payload);
      }
    }catch(e){
      console.error("Error guardando resultados de Bubble Pop", e);
    }

    // marcar este vino como jugado
    winePlayed[currentWineId] = true;
    updateWineAvailabilityUI();

    let nivel;
    if(score >= 12) nivel = "Sniper arom√°tico ü´ßüçã";
    else if(score >= 7) nivel = "Muy buena punter√≠a üòè";
    else if(score >= 3) nivel = "Punter√≠a curiosa üëÄ";
    else nivel = "Todav√≠a calentando dedo üòÑ";

    const remaining = Object.keys(wines).filter(id => !winePlayed[id]);

    if(remaining.length === 0){
      // RESUMEN FINAL DE LOS 5 VINOS
      overlayTitleEl.textContent = "Resumen final de tus 5 vinos";
      overlaySubEl.textContent = "Puntuaciones de tu Bubble Pop de Aromas.";
      finalStatsEl.innerHTML = buildFinalSummaryHTML();
      restartOverlayBtn.style.display = "none";
      statusText.textContent = "Has completado los 5 vinos. Resultados listos para el dashboard. ü•≥";
    }else{
      // resumen solo del vino actual (como antes)
      overlayTitleEl.textContent = "Fin de la partida";
      overlaySubEl.textContent = "Resumen de tu Bubble Pop arom√°tico üç∑";
      finalStatsEl.innerHTML = `
        Vino jugado: <b>${activeWine.short}</b><br>
        Uvas: <b>${activeWine.grapes}</b><br><br>
        ‚úÖ Aciertos: <b>${score}</b><br>
        ‚ùå Burbujas mal reventadas: <span class="bad"><b>${mistakes}</b></span><br>
        üí® Aromas buenos que se escaparon: <b>${missed}</b><br>
        üéØ Precisi√≥n al tocar: <b>${accuracy}%</b><br><br>
        Nivel de punter√≠a arom√°tica:<br><b>${nivel}</b><br><br>
        <small>Recuerda: solo tienes una partida por vino.</small>
      `;
      statusText.textContent = "Partida terminada para " + activeWine.short + ". Pulsa ‚ÄúJugar con otro vino‚Äù o cambia en el men√∫.";
      restartOverlayBtn.style.display = "inline-flex";
    }

    endOverlay.classList.add("show");
  }

  function buildFinalSummaryHTML(){
    let html = "Resumen de tus 5 vinos jugados:<br><br>";
    const ids = WINE_ORDER;
    ids.forEach(id => {
      const w = wines[id];
      const r = wineResults[id];
      if(!r) return;
      html += `
        <div style="margin-bottom:10px;">
          <b>${w.short}</b><br>
          ‚úÖ Aciertos: <b>${r.score}</b> ¬∑ ‚ùå Malas: <b>${r.mistakes}</b> ¬∑ üí® Escapan: <b>${r.missed}</b><br>
          üéØ Precisi√≥n: <b>${r.accuracy}%</b>
        </div>
      `;
    });

    const all = Object.values(wineResults || {});
    if(all.length){
      let totalScore = 0;
      let totalMistakes = 0;
      let totalMissed = 0;
      let sumAcc = 0;
      all.forEach(r => {
        totalScore += r.score || 0;
        totalMistakes += r.mistakes || 0;
        totalMissed += r.missed || 0;
        sumAcc += r.accuracy || 0;
      });
      const avgAcc = Math.round(sumAcc / all.length);
      html += `
        <br>
        <b>Resumen global:</b><br>
        ‚úÖ Aciertos totales: <b>${totalScore}</b><br>
        ‚ùå Fallos totales: <b>${totalMistakes}</b><br>
        üí® Burbujas buenas que se escaparon: <b>${totalMissed}</b><br>
        üéØ Precisi√≥n media: <b>${avgAcc}%</b>
      `;
    }
    return html;
  }

  function loop(timestamp){
    if(!gameRunning) return;

    if(lastFrameTime === null){
      lastFrameTime = timestamp;
      requestAnimationFrame(loop);
      return;
    }

    const dt = (timestamp - lastFrameTime) / 1000;
    lastFrameTime = timestamp;

    remainingMs -= dt * 1000;
    if(remainingMs < 0) remainingMs = 0;
    timerEl.textContent = formatTime(remainingMs);

    spawnAccumulator += dt;
    if(spawnAccumulator >= SPAWN_INTERVAL_SEC){
      spawnAccumulator = 0;
      spawnBubble();
    }

    const fieldRect = playfield.getBoundingClientRect();
    const toRemove = [];
    bubbles.forEach(b => {
      b.__y -= b.__speed * dt;
      b.style.top = b.__y + "px";
      if(b.__y + 50 < 0){
        toRemove.push(b);
        const isGood = b.dataset.good === "1";
        if(isGood){
          missed++;
          missedEl.textContent = String(missed);
        }
      }
    });
    toRemove.forEach(b => {
      if(playfield.contains(b)){
        playfield.removeChild(b);
      }
      bubbles = bubbles.filter(x => x !== b);
    });

    if(remainingMs <= 0){
      gameRunning = false;
      clearBubbles();
      endGame();
      return;
    }

    requestAnimationFrame(loop);
  }

  function updateWineAvailabilityUI(){
    const options = Array.from(wineSelect.options);
    options.forEach(opt => {
      const id = opt.value;
      if(winePlayed[id]){
        opt.textContent = opt.textContent.replace("¬∑","¬∑ ‚úÖ");
        opt.disabled = false;
      }
    });
  }

  function startGame(){
    if(gameRunning) return;

    if(winePlayed[currentWineId]){
      showToast("Este vino ya est√° jugado. Elige otro vino.");
      statusText.textContent = "Este vino ya est√° jugado. Cambia de vino en el men√∫ desplegable.";
      return;
    }

    const remaining = Object.keys(wines).filter(id => !winePlayed[id]);
    if(remaining.length === 0){
      showToast("Ya has jugado los 5 vinos. Revisa el resumen final.");
      statusText.textContent = "Has jugado los 5 vinos. Usa de nuevo la cata para comentar los resultados.";
      return;
    }

    gameRunning = true;
    lastFrameTime = null;
    remainingMs = GAME_DURATION_MS;
    spawnAccumulator = 0;
    clearBubbles();
    resetCounters();

    wineSelect.disabled = true;

    statusText.textContent = "Partida en curso: toca solo los aromas que encajen con el vino.";
    showToast("Partida iniciada ¬∑ revienta las burbujas correctas ü´ß");

    requestAnimationFrame(loop);
  }

  hintBtn.addEventListener("click", ()=>{
    const w = getActiveWine();
    showToast("Pista: " + w.tags);
    statusText.textContent = "Pista de aromas clave para este vino: " + w.tags + ".";
  });

  startBtn.addEventListener("click", startGame);

  wineSelect.addEventListener("change", ()=>{
    if(gameRunning) return;
    currentWineId = wineSelect.value;
    updateWineUI();
  });

  closeOverlayBtn.addEventListener("click", ()=>{
    endOverlay.classList.remove("show");
  });

  restartOverlayBtn.addEventListener("click", ()=>{
    endOverlay.classList.remove("show");
    const remaining = Object.keys(wines).filter(id => !winePlayed[id]);
    if(remaining.length){
      currentWineId = remaining[0];
      wineSelect.value = currentWineId;
      updateWineUI();
    }
    startGame();
  });

  timerEl.textContent = formatTime(GAME_DURATION_MS);
  updateWineUI();
})();
  </script>
</body>
</html>
